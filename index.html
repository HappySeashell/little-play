<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WWWå°å‰§åœºç”ŸæˆåŠ©æ‰‹</title>
    <style>
        /* å…¨å±€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-top: 80px;
        }

        /* æµ®åŠ¨å¯¼èˆªæ  */
        .floating-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 15px 20px;
        }

        .nav-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .nav-content button {
            background: white;
            border: 1px solid #cbd5e1;
            color: #475569;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .nav-content button:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        /* å¤´éƒ¨åŒºåŸŸ */
        .header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 30px;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* ä½¿ç”¨è¯´æ˜æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal h2 {
            color: #3b82f6;
            margin-bottom: 15px;
        }

        .modal p {
            line-height: 1.8;
            color: #555;
            margin-bottom: 10px;
        }

        .modal a {
            color: #3b82f6;
            text-decoration: none;
        }

        .modal a:hover {
            text-decoration: underline;
        }

        /* ä¸»ä½“å†…å®¹ */
        .content {
            padding: 30px;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        /* å­—æ®µå¼€å…³æ ·å¼ */
        .field-toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #cbd5e1;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .toggle-switch.active {
            background: #3b82f6;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 26px;
        }

        .form-group.disabled {
            opacity: 0.5;
        }

        .form-group.disabled input,
        .form-group.disabled textarea,
        .form-group.disabled select {
            pointer-events: none;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #334155;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .required::after {
            content: '*';
            color: #ef4444;
            margin-left: 4px;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .hint {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }

        /* å•é€‰æŒ‰é’®æ ·å¼ */
        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }

        .radio-group input[type="radio"],
        .radio-group input[type="checkbox"] {
            margin-right: 8px;
        }

        /* è‡ªå®šä¹‰å­—æ®µåŒºåŸŸ */
        .custom-fields {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e2e8f0;
        }

        .custom-field {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            position: relative;
        }

        .custom-field.disabled {
            opacity: 0.5;
        }

        .custom-field.disabled input,
        .custom-field.disabled textarea,
        .custom-field.disabled select,
        .custom-field.disabled button {
            pointer-events: none;
        }

        .custom-field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .custom-field-actions {
            display: flex;
            gap: 8px;
        }

        .copy-field-btn, .move-up-btn, .move-down-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-field-btn:hover, .move-up-btn:hover, .move-down-btn:hover {
            background: #4f46e5;
        }

        .remove-field-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-field-btn:hover {
            background: #dc2626;
        }

        .add-field-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 15px;
        }

        .add-field-btn:hover {
            background: #059669;
        }

        /* è¾“å‡ºæ–‡æœ¬å— */
        .output-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e2e8f0;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .output-header h3 {
            color: #334155;
        }

        .output-actions {
            display: flex;
            gap: 10px;
        }

        .copy-btn, .save-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .copy-btn:hover, .save-btn:hover {
            background: #2563eb;
        }

        .save-btn {
            background: #10b981;
        }

        .save-btn:hover {
            background: #059669;
        }

        .output-box {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
        }

        .output-box:empty::before {
            content: 'ä¿®æ”¹è¡¨å•å†…å®¹ä¼šè‡ªåŠ¨ç”Ÿæˆ...';
            color: #64748b;
        }

        /* é¢„è§ˆåŒºåŸŸ */
        .preview-section {
            margin-top: 20px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
        }

        .preview-btn {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .preview-btn:hover {
            background: #7c3aed;
        }

        .preview-box {
            background: #f1f5f9;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            color: #334155;
        }

        .preview-box:empty::before {
            content: 'ç‚¹å‡»"æŠ½ä¸€å‘ï¼"æŒ‰é’®æŸ¥çœ‹æŠ½å–ç»“æœ...';
            color: #94a3b8;
        }

        /* é…ç½®åˆ—è¡¨æ¨¡æ€æ¡† */
        .config-list {
            margin-top: 20px;
        }

        .config-search {
            margin-bottom: 20px;
        }

        .config-search-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .config-search input {
            flex: 1;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
        }

        /* Toggleå¼€å…³æ ·å¼ */
        .search-toggle {
            display: flex;
            background: #f1f5f9;
            border-radius: 20px;
            padding: 4px;
            gap: 4px;
        }

        .search-toggle-option {
            padding: 6px 16px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 13px;
            color: #64748b;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .search-toggle-option.active {
            background: #3b82f6;
            color: white;
        }

        .config-sort {
            margin-bottom: 15px;
        }

        .config-sort label {
            font-size: 14px;
            color: #334155;
            margin-right: 10px;
        }

        .config-sort select {
            padding: 6px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 13px;
        }

        .config-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-item:hover {
            background: #f1f5f9;
        }

        .config-name {
            font-weight: 600;
            color: #334155;
            cursor: pointer;
            flex: 1;
            padding: 5px;
            border: 2px solid transparent;
            border-radius: 4px;
        }

        .config-name:hover {
            color: #3b82f6;
        }

        .config-name.editing {
            border-color: #3b82f6;
            background: white;
            cursor: text;
        }

        .config-time {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }

        .config-actions {
            display: flex;
            gap: 8px;
        }

        .config-actions button {
            padding: 5px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 12px;
        }

        .rename-btn {
            background: #3b82f6;
            color: white;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        /* é€‰é¡¹ç¼–è¾‘å™¨ */
        .options-editor {
            margin-top: 10px;
        }

        .options-editor.edit-mode .option-item {
            display: flex;
        }

        .options-editor.view-mode .option-item {
            display: none;
        }

        .options-editor.edit-mode .add-option-btn {
            display: inline-block;
        }

        .options-editor.view-mode .add-option-btn {
            display: none;
        }

        .options-display {
            display: none;
        }

        .options-editor.view-mode .options-display {
            display: block;
        }

        .option-item {
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }

        .option-item input {
            flex: 1;
        }

        .option-item button {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-option-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
        }

        .toggle-edit-btn {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }

        .toggle-edit-btn:hover {
            background: #d97706;
        }

        /* è‡ªå®šä¹‰æ ‡ç­¾è¾“å…¥ */
        .custom-tag-input {
            margin-top: 10px;
            display: none;
        }

        .custom-tag-input input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
        }

        /* æç¤ºæ¶ˆæ¯ */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            display: none;
            animation: slideIn 0.3s;
        }

        .toast.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                padding-top: 100px;
            }

            .floating-nav {
                padding: 10px;
            }

            .nav-content {
                justify-content: center;
                gap: 6px;
            }

            .nav-content button {
                padding: 6px 12px;
                font-size: 12px;
                flex: 1 1 auto;
                min-width: 70px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 22px;
            }

            .content {
                padding: 20px;
            }

            .modal-content {
                padding: 20px;
            }

            .output-actions, .preview-actions {
                flex-direction: column;
            }

            .config-search-row {
                flex-direction: column;
                align-items: stretch;
            }

            .search-toggle {
                justify-content: center;
            }
        }

        /* éšè—çš„æ–‡ä»¶è¾“å…¥ */
        #import-file {
            display: none;
        }

        /* éšæœºæ¬¡æ•°è¾“å…¥ */
        .repeat-count {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .repeat-count label {
            margin: 0;
            font-weight: normal;
            font-size: 14px;
        }

        .repeat-count input {
            width: 80px;
        }

        .no-results {
            text-align: center;
            color: #64748b;
            padding: 20px;
            font-size: 14px;
        }

        /* æ»šåŠ¨æŒ‰é’® */
        .scroll-btn {
            position: fixed;
            right: 20px;
            width: 48px;
            height: 48px;
            background: rgba(59, 130, 246, 0.9);
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .scroll-btn:hover {
            background: rgba(37, 99, 235, 0.9);
            transform: scale(1.1);
        }

        .scroll-btn.show {
            display: flex;
        }

        .scroll-to-top {
            bottom: 90px;
        }

        .scroll-to-bottom {
            bottom: 30px;
        }

        @media (max-width: 768px) {
            .scroll-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .scroll-to-top {
                bottom: 70px;
            }

            .scroll-to-bottom {
                bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- æµ®åŠ¨å¯¼èˆªæ  -->
    <div class="floating-nav">
        <div class="nav-content">
            <button onclick="openConfigList()">ğŸ“‹ é…ç½®åˆ—è¡¨</button>
            <button onclick="exportConfig('json')">ğŸ“¤ å¯¼å‡ºJSON</button>
            <button onclick="exportConfig('txt')">ğŸ“¤ å¯¼å‡ºTXT</button>
            <button onclick="document.getElementById('import-file').click()">ğŸ“¥ å¯¼å…¥é…ç½®</button>
            <button onclick="openHelp()">ä½¿ç”¨è¯´æ˜</button>
            <input type="file" id="import-file" accept=".json,.txt" onchange="importConfig(event)">
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>å°å‰§åœºç”ŸæˆåŠ©æ‰‹</h1>
            <p>â€”â€”ä½œè€…:WWW</p>
        </div>

        <!-- ä¸»ä½“å†…å®¹ -->
        <div class="content">
            <form id="main-form">
                <!-- 1. æ ‡é¢˜ -->
                <div class="form-group" data-field="title">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label class="required">å°å‰§åœºæ ‡é¢˜</label>
                    </div>
                    <input type="text" id="title" value="ç•ªå¤–" required oninput="autoGenerate()">
                </div>

                <!-- 2. ä½¿ç”¨æ¨¡å¼ -->
                <div class="form-group" data-field="mode">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label class="required">ä½¿ç”¨æ¨¡å¼</label>
                    </div>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="mode" value="independent" checked onchange="toggleModeOptions(); autoGenerate();">
                            ç‹¬ç«‹ä½¿ç”¨
                        </label>
                        <label>
                            <input type="radio" name="mode" value="worldbook" onchange="toggleModeOptions(); autoGenerate();">
                            WWWå°å‰§åœº
                        </label>
                        <label>
                            <input type="radio" name="mode" value="puppy" onchange="toggleModeOptions(); autoGenerate();">
                            å°ç‹—ä¹‹ç¥å°å‰§åœº
                        </label>
                        <label>
                            <input type="radio" name="mode" value="custom" onchange="toggleModeOptions(); autoGenerate();">
                            ä½œä¸ºå…¶ä»–ä¸–ç•Œä¹¦æ¡ç›®
                        </label>
                    </div>
                    <div class="custom-tag-input" id="custom-tag-input">
                        <label>è‡ªå®šä¹‰æ ‡ç­¾åç§°</label>
                        <input type="text" id="custom-tag" placeholder="ä¾‹å¦‚: my-tag" value="little-play" oninput="autoGenerate()">
                        <div class="hint">æ ‡ç­¾æ ¼å¼å°†ä¸º: &lt;æ ‡ç­¾åç§°&gt;...&lt;/æ ‡ç­¾åç§°&gt;</div>
                    </div>
                </div>

                <!-- 3. ç”Ÿæˆè¦æ±‚ -->
                <div class="form-group" data-field="requirements">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label class="required">ç”Ÿæˆè¦æ±‚</label>
                    </div>
                    <textarea id="requirements" required oninput="autoGenerate()">- æ•…äº‹ä¸­çš„è§’è‰²æ›´æ¢è‡³å…¶ä»–ä¸–ç•Œè§‚,ç”Ÿæˆä¸€æ®µå®Œæ•´çš„å°æ•…äº‹,ä»¥ä¸»è¦è§’è‰²é—´çš„å¯¹è¯å’Œäº’åŠ¨ä¸ºæ ¸å¿ƒ,å±•ç°è§’è‰²ä¹‹é—´çš„æƒ…æ„Ÿå…³ç³»,å†…å®¹è¶³å¤Ÿæ–°é¢–å¸å¼•äººã€‚
- è§’è‰²è‡ªåŠ¨é€‚é…ä¸ºè¯¥ä¸–ç•Œè§‚ä¸‹åˆé€‚çš„èº«ä»½,ä¸å¾—æ›´æ”¹ä¸ºè¯¥ä¸–ç•Œè§‚ä¸‹å·²å­˜åœ¨çš„è§’è‰²ã€‚ä¾‹å¦‚,å¦‚æœä¸–ç•Œè§‚æ˜¯åœ£æ¯æˆ˜äº‰,ä¸å¾—å°†{{user}}è®¾å®šä¸ºå«å®«åˆ‡å—£,è€Œæ˜¯è¦è®¾å®šä¸ºè¯¥ä¸–ç•Œè§‚ä¸‹åä¸º{{user}}çš„æ–°è§’è‰²ã€‚
- å¯æ ¹æ®éœ€è¦è¡¥å……èƒŒæ™¯æ¿NPCå‚ä¸å‰§æƒ…,ä½†ä¸èƒ½ç€å¢¨å¤ªå¤š,åªèƒ½ä½œä¸ºä¸»è¦è§’è‰²çš„è¡¬æ‰˜ã€‚</textarea>
                </div>

                <!-- 4. æ•…äº‹èƒŒæ™¯ -->
                <div class="form-group" data-field="background">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label>æ•…äº‹èƒŒæ™¯</label>
                    </div>
                    <textarea id="background" oninput="autoGenerate()">è‡ªç”±å‘æŒ¥,
è§’è‰²ä»¬å‡ä¸ºè¿™ä¸ªä¸–ç•Œçš„åŸä½æ°‘,
è§’è‰²ä»¬å‡ä¸ºåˆšåˆšç©¿è¶Šæ¥åˆ°è¿™ä¸ªä¸–ç•Œçš„,
è§’è‰²ä»¬å‡ä¸ºç©¿è¶Šæ¥åˆ°è¿™ä¸ªä¸–ç•Œçš„ï¼Œå·²ç»ç©¿è¶Šå¾ˆä¹…äº†,
{{user}}å¸¦ç€å¿«ç©¿ç³»ç»Ÿç©¿è¶Šåˆ°è¿™ä¸ªä¸–ç•Œï¼Œè€Œ{{char}}æ˜¯è¿™ä¸ªä¸–ç•Œçš„åŸä½æ°‘ï¼Œ{{user}}çš„ä»»åŠ¡æ˜¯æ”»ç•¥{{char}},
{{char}}å¸¦ç€å¿«ç©¿ç³»ç»Ÿç©¿è¶Šåˆ°è¿™ä¸ªä¸–ç•Œï¼Œè€Œ{{user}}æ˜¯è¿™ä¸ªä¸–ç•Œçš„åŸä½æ°‘ï¼Œ{{char}}çš„ä»»åŠ¡æ˜¯æ”»ç•¥{{user}},
è§’è‰²ä»¬å¸¦ç€å¿«ç©¿ç³»ç»Ÿç©¿è¶Šåˆ°è¿™ä¸ªä¸–ç•Œï¼Œæœ‰ç€ä¸€ä¸ªç‰¹å®šçš„ä»»åŠ¡è¦å®Œæˆ,
è§’è‰²ä»¬è¢«è¿«ç©¿è¶Šåˆ°è¿™ä¸ªä¸–ç•Œï¼Œè¦å®Œæˆä¸€ä¸ªç‰¹å®šçš„ä»»åŠ¡æ‰èƒ½å›åˆ°åŸä¸–ç•Œ,
è§’è‰²ä»¬å¸¦ç€å‰ä¸–ï¼ˆä¸»çº¿ï¼‰çš„è®°å¿†æŠ•èƒåˆ°è¿™ä¸ªä¸–ç•Œ,
è§’è‰²ä»¬æŠ•èƒåˆ°è¿™ä¸ªä¸–ç•Œï¼Œä½†æ˜¯ä¸¢å¤±äº†å‰ä¸–ï¼ˆä¸»çº¿ï¼‰çš„è®°å¿†,
è§’è‰²ä»¬å¸¦ç€å‰ä¸–ï¼ˆä¸»çº¿ï¼‰çš„è®°å¿†åœ¨è¿™ä¸ªä¸–ç•Œè½®å›,
è§’è‰²ä»¬æ‰€åœ¨çš„è¿™ä¸ªä¸–ç•Œå®é™…ä¸Šæ˜¯è™šæ‹Ÿä¸–ç•Œï¼ŒTAä»¬ä¸çŸ¥é“è‡ªå·±èº«åœ¨è™šæ‹Ÿä¸–ç•Œä¸­ï¼Œè€Œä¸Šä½ä¸–ç•Œæœ‰ä¸€äº›è§‚ä¼—åœ¨å›´è§‚ä»–ä»¬çš„ç”Ÿæ´»ç›´æ’­,
è§’è‰²ä»¬æ‰€åœ¨çš„è¿™ä¸ªä¸–ç•Œå®é™…ä¸Šæ˜¯è™šæ‹Ÿä¸–ç•Œï¼ŒTAä»¬çŸ¥é“è‡ªå·±èº«åœ¨è™šæ‹Ÿä¸–ç•Œä¸­ï¼Œè€Œä¸Šä½ä¸–ç•Œæœ‰ä¸€äº›è§‚ä¼—åœ¨å›´è§‚ä»–ä»¬çš„ç”Ÿæ´»ç›´æ’­ï¼ŒTAä»¬éœ€è¦æ»¡è¶³è§‚ä¼—çš„ä¸€äº›è¦æ±‚,
{{char}}æ˜¯{{user}}å‰ä¸–ï¼ˆä¸»çº¿å‰§æƒ…ï¼‰çš„æ‹äººï¼Œä½†æ˜¯{{user}}å·²ç»å¿˜äº†{{char}},
{{user}}æ˜¯{{char}}å‰ä¸–ï¼ˆä¸»çº¿å‰§æƒ…ï¼‰çš„æ‹äººï¼Œä½†æ˜¯{{char}}å·²ç»å¿˜äº†{{user}},
{{char}}å’Œ{{user}}æ˜¯å‰ä¸–ï¼ˆä¸»çº¿å‰§æƒ…ï¼‰çš„æ‹äººï¼Œä½†æ˜¯TAä»¬å·²ç»å¿˜äº†å½¼æ­¤,
{{char}}è¢«å›°åœ¨äº†è¿™ä¸ªä¸–ç•Œé‡Œï¼Œè€Œ{{user}}æ˜¯æ¥æ•‘TAå‡ºå»çš„,
{{user}}è¢«å›°åœ¨äº†è¿™ä¸ªä¸–ç•Œé‡Œï¼Œè€Œ{{char}}æ˜¯æ¥æ•‘TAå‡ºå»çš„</textarea>
                    <div class="hint">å½“éœ€è¦åœ¨å¤šä¸ªèƒŒæ™¯ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªæ—¶,è¯·ç”¨è‹±æ–‡é€—å·åˆ†éš”ã€‚</div>
                </div>

                <!-- 5. æ–‡é£è¦æ±‚ -->
                <div class="form-group" data-field="style">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label>æ–‡é£è¦æ±‚</label>
                    </div>
                    <textarea id="style" oninput="autoGenerate()">æ­£å‰§,
å²è¯—æ„Ÿ,
è½»æ¾è¯™è°åæ§½,
æç¬‘æ’•é€¼,
è™å‘,
çº¯çˆ±ç…½æƒ…,
NSFW</textarea>
                    <div class="hint">å½“éœ€è¦åœ¨å¤šä¸ªæ–‡é£ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªæ—¶,è¯·ç”¨è‹±æ–‡é€—å·åˆ†éš”ã€‚</div>
                </div>

                <!-- 6. ä¸–ç•Œè§‚&é¢˜æè¦æ±‚ -->
                <div class="form-group" data-field="worldview">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label class="required">ä¸–ç•Œè§‚&é¢˜æè¦æ±‚</label>
                    </div>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="worldview" value="consistent" onchange="toggleWorldviewInput(); autoGenerate();">
                            å’Œä¸»çº¿ä¸€è‡´
                        </label>
                        <label>
                            <input type="radio" name="worldview" value="custom" checked onchange="toggleWorldviewInput(); autoGenerate();">
                            è‡ªå®šä¹‰
                        </label>
                    </div>
                    <textarea id="worldview-custom" style="margin-top: 10px;" oninput="autoGenerate()">è‡ªç”±æŒ‡å®šä¸€ä¸ªAU,è‡ªç”±æŒ‡å®šä¸€ä¸ªæ¸¸æˆAU,è‡ªç”±æŒ‡å®šä¸€ä¸ªç°å®ä½œå“çš„AU,
è™«æ—ï¼ˆç¤¾ä¼šç»“æ„åŒ…å«è™«æ¯ã€é›„è™«ã€äºšé›Œï¼Œè™«æ¯ä¸ºå°Šï¼‰,è™«æ—ï¼ˆç¤¾ä¼šç»“æ„åŒ…å«é›„è™«ã€é›Œè™«ã€äºšé›Œï¼Œé›„è™«ä¸ºå°Šï¼Œé›Œè™«å¤§éƒ¨åˆ†ä¸ºå†›é›Œï¼‰,å“¨å…µå‘å¯¼,ABO,dom/sub,å…½äºº,
é¾™å‚²å¤©æ–‡å­¦,ç‹—è¡€å°è¨€æ–‡,æ‹çˆ±å°‘å¥³æ¼«,çƒ­è¡€å°‘å¹´æ¼«,æ™‹æ±Ÿæ–‡å­¦,æµ·æ£ æ–‡å­¦,
å…‹è‹é²,è¡€æ—,åœ£æ¯æˆ˜äº‰,é­”æ³•å°‘å¥³å°åœ†,EVA,éœæ ¼æ²ƒå…¹,è¶…çº§è‹±é›„,ç›—å¢“ç¬”è®°,é»‘å¡”åˆ©äºš,JOJOçš„å¥‡å¦™å†’é™©ï¼ˆå¯ä»¥ä½œä¸ºæ›¿èº«ä½¿è€…æˆ–æ›¿èº«ï¼‰,è¥¿æ¸¸è®°,
èµ›åšæœ‹å…‹2077,åº•ç‰¹å¾‹å˜äºº,é˜´é˜³å¸ˆæ‰‹æ¸¸,å‰‘ç½‘ä¸‰,
è¥¿å¹»,DND,
è’¸æ±½æœ‹å…‹,èµ›åšæœ‹å…‹,ææ€–æ€ªè°ˆ,è§„åˆ™æ€ªè°ˆ,æ˜Ÿé™…,æ˜Ÿé™…æœºç”²,æ˜Ÿçƒå¤§æˆ˜,æ— é™ææ€–,æ— é™æµ,
è¿‘æœªæ¥,ç§‘å¹»,æœ«ä¸–åºŸåœŸ,åå¯ç¤ºå½•,æœ«æ—¥å°†è‡³,æœ«ä¸–ç§ç”°,æœ«ä¸–å¼‚èƒ½,
æ¶ç©ºå†å²,ä¸­å›½å¤ä»£,æ˜¥ç§‹æˆ˜å›½,ç§¦æœ,ä¸‰å›½,å”æœ,å®‹æœ,æ˜æœ,æ¸…æœ,æ°‘å›½,é©å‘½å¹´ä»£,çŸ¥é’ä¸‹ä¹¡,
æ—¥æœ¬å¹³å®‰æ—¶ä»£,æ—¥æœ¬æ±Ÿæˆ·æ—¶ä»£,æ—¥æœ¬å¤§æ­£æ—¶ä»£,
æ¬§æ´²ä¸­ä¸–çºª,æ¬§æ´²æ–‡è‰ºå¤å…´æ—¶æœŸ,æ¬§æ´²è¿‘ä»£,
ä¸€æˆ˜,äºŒæˆ˜,æˆ˜äº‰å¹´ä»£,ç¬¬ä¸‰æ¬¡ä¸–ç•Œå¤§æˆ˜,
æ­¦ä¾ ,æ­¦ä¾ ï¼ˆé‡‘åº¸ä½œå“ï¼‰,ä¸­å¼ç„å¹»,ä»™ä¾ ä¿®çœŸ,ä¸­å¼å¦–ç¥,
æ¶ç©ºç¥è¯,å¸Œè…Šç¥è¯,å¸Œä¼¯æ¥ç¥è¯,å°åº¦ç¥è¯,åŸƒåŠç¥è¯,ä¸­å›½æ´ªè’ç¥è¯,ä¸­å›½ç¥è¯,æ—¥æœ¬å¦–ç¥,
å·¥åœ°æƒ…ç¼˜(TAä»¬æ˜¯å·¥å‹),é’æ˜¥æ ¡å›­,å¨±ä¹åœˆï¼ˆç»¼è‰º/å›¢ç»¼å‡ºé“/æ¼”å‘˜ï¼‰,å°å¦ˆæ–‡å­¦,é»‘å¸®,è­¦åŒªï¼ˆçŒ«é¼ æ¸¸æˆï¼‰,æ¨ç†ç ´æ¡ˆ</textarea>
                    <div class="hint">å½“éœ€è¦åœ¨å¤šä¸ªä¸–ç•Œè§‚&é¢˜æä¸­éšæœºé€‰æ‹©ä¸€ä¸ªæ—¶,è¯·ç”¨è‹±æ–‡é€—å·åˆ†éš”ã€‚</div>
                </div>

                <!-- 7. ç¯‡å¹…è¦æ±‚ -->
                <div class="form-group" data-field="length">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label class="required">ç¯‡å¹…è¦æ±‚</label>
                    </div>
                    <input type="number" id="length" value="3000" min="1" required oninput="autoGenerate()">
                </div>

                <!-- 8. ä½“è£è¦æ±‚ -->
                <div class="form-group" data-field="genre">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label>ä½“è£è¦æ±‚</label>
                    </div>
                    <textarea id="genre" oninput="autoGenerate()">è‡ªç”±å‘æŒ¥,è¯—æ­Œ,æˆå‰§,ç”µå½±åˆ†é•œ,å°è¯´,è§†è§‰å°è¯´,è®ºæ–‡,ç ”ç©¶æŠ¥å‘Š,æ•£æ–‡,æ‚æ–‡,æ—¥è®°,å›å¿†å½•,äººç‰©æ¡£æ¡ˆ,è®ºå›å¸–å­,ä¸ªäººä¸»é¡µ,è¯­å½•,ç®´è¨€,æ‘˜æŠ„,æ–°é—»æŠ¥é“,ç®€æŠ¥,å…¬å‘Š,æ—¥å¿—,ç¬”è®°,å½’æ¡£è®°å½•,æœ‹å‹åœˆ,å›å¿†ç›¸å†Œ</textarea>
                    <div class="hint">å½“éœ€è¦åœ¨å¤šä¸ªä½“è£ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªæ—¶,è¯·ç”¨è‹±æ–‡é€—å·åˆ†éš”ã€‚</div>
                </div>

                <!-- 9. å…ƒç´ è¦æ±‚ -->
                <div class="form-group" data-field="elements">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label>å…ƒç´ è¦æ±‚</label>
                    </div>
                    <textarea id="elements" oninput="autoGenerate()">è‡ªç”±å‘æŒ¥ï¼Œè¶Šç‹—è¡€è¶Šæ¶ä¿—è¶Šå¥½,é‡Œç•ªç»å…¸å‰§æƒ…,éœ¸æ€»æ–‡å­¦ç»å…¸å‰§æƒ…,è¨€æƒ…ç»å…¸å‰§æƒ…,ç›ä¸½è‹æ–‡å­¦ç»å…¸å‰§æƒ…,é¾™å‚²å¤©æ–‡å­¦ç»å…¸å‰§æƒ…,è¿ªåŒ–æµç»å…¸å‰§æƒ…,å°å¦ˆæ–‡å­¦,å…ˆå©šåçˆ±,å©šç¤¼å½“å¤©æŠ¢å©š,èµ›åšå¿æ‚”å®¤,ç¤¾æ­»ç°åœº,å®«å»·æƒè°‹,å›šç¦play,ç½‘æ‹å¥”ç°,ç§å¥”</textarea>
                    <div class="hint">å½“éœ€è¦åœ¨å¤šä¸ªå…ƒç´ ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªæ—¶,è¯·ç”¨è‹±æ–‡é€—å·åˆ†éš”ã€‚â€œæŠ½å–æ¬¡æ•°â€ç”¨äºæŒ‡å®šéœ€è¦é€‰æ‹©çš„éšæœºå…ƒç´ ä¸ªæ•°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæŠŠâ€œæŠ½å–æ¬¡æ•°â€è®¾ç½®æˆ3ï¼Œåˆ™ä¼šåœ¨å…ƒç´ åˆ—è¡¨é‡Œè¿›è¡Œä¸‰æ¬¡æŠ½å–ã€‚</div>
                    <div class="repeat-count">
                        <label>æŠ½å–æ¬¡æ•°:</label>
                        <input type="number" id="elements-repeat" value="1" min="1" max="99" oninput="autoGenerate()">
                    </div>
                </div>

                <!-- è‡ªå®šä¹‰å­—æ®µåŒºåŸŸ -->
                <div class="custom-fields">
                    <h3 style="margin-bottom: 20px; color: #334155;">è‡ªå®šä¹‰å­—æ®µ</h3>
                    <div id="custom-fields-container"></div>
                    <button type="button" class="add-field-btn" onclick="addCustomField()">â• æ·»åŠ è‡ªå®šä¹‰å­—æ®µ</button>
                </div>
            </form>

            <!-- è¾“å‡ºæ–‡æœ¬å— -->
            <div class="output-section">
                <div class="output-header">
                    <h3>ç”Ÿæˆç»“æœ</h3>
                    <div class="output-actions">
                        <button class="copy-btn" onclick="copyOutput()">ğŸ“‹ å¤åˆ¶</button>
                        <button class="save-btn" onclick="saveCurrentConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    </div>
                </div>
                <div class="output-box" id="output"></div>
                
                <!-- é¢„è§ˆåŒºåŸŸ -->
                <div class="preview-section">
                    <div class="preview-header">
                        <h4 style="color: #334155;">éšæœºç»“æœé¢„è§ˆ</h4>
                        <div class="preview-actions">
                            <button class="copy-btn" onclick="copyPreview()">ğŸ“‹ å¤åˆ¶</button>
                            <button class="preview-btn" onclick="generatePreview()">ğŸ² æŠ½ä¸€å‘ï¼</button>
                        </div>
                    </div>
                    <div class="preview-box" id="preview"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä½¿ç”¨è¯´æ˜æ¨¡æ€æ¡† -->
    <div class="modal" id="help-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeHelp()">âœ•</button>
            <h2>ä½¿ç”¨è¯´æ˜</h2>
            <p>æœ¬å·¥å…·å¯ä»¥ç”Ÿæˆæ ¼å¼åŒ–çš„å°å‰§åœº,å¹¶å¯é€šè¿‡é…’é¦†æä¾›çš„å®{{random:...}}æ¥è¿›è¡Œéšæœºé€‰é¡¹é€‰æ‹©ï¼Œæå‡ç”Ÿæˆå¤šæ ·æ€§ã€‚è¿˜æ”¯æŒæ·»åŠ è‡ªå®šä¹‰å­—æ®µï¼Œå¡«å†™ä½ æƒ³è¦å®ç°çš„è¦æ±‚ã€‚åœ¨å‘é€åˆ°é…’é¦†èŠå¤©é‡Œæ—¶ï¼Œ{{random:...}}å†…çš„é€‰é¡¹åªä¼šæœ‰ä¸€ä¸ªè¢«éšæœºé€‰æ‹©æ˜¾ç¤ºå‡ºæ¥ï¼Œä¸ä¼šéƒ½å‘é€ç»™AIã€‚</p>
            <p>ç‚¹å‡»ä¸Šæ–¹â€œä¿å­˜é…ç½®â€æŒ‰é’®å¯ä»¥ä¿å­˜é…ç½®ã€‚ç‚¹å‡»â€œå¯¼å…¥/å¯¼å‡ºé…ç½®â€å¯ä»¥å°†é…ç½®æ–‡ä»¶ä»¥JSONæ ¼å¼å¯¼å…¥/å¯¼å‡ºï¼Œæ–¹ä¾¿åˆ†äº«ã€‚</p>
            <p>æ›´æ–°é“¾æ¥: <a href="https://discord.com/channels/1291925535324110879/1421177491959316570/1421177491959316570" target="_blank">Discordæ›´æ–°é“¾æ¥</a>ã€‚åŒæ—¶æˆ‘ä¹Ÿåœ¨å†™ä¸€ç³»åˆ—å°å‰§åœºå’Œå°å·¥å…·ï¼Œæ¬¢è¿ä½“éªŒå’Œrepo~~æœ‰å¥½é¥­èƒ½è®©æˆ‘ä¹Ÿåƒä¸€åƒå—ğŸ¥¹</p>
        </div>
    </div>

    <!-- é…ç½®åˆ—è¡¨æ¨¡æ€æ¡† -->
    <div class="modal" id="config-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeConfigList()">âœ•</button>
            <h2>é…ç½®åˆ—è¡¨</h2>
            
            <div class="config-search">
                <div class="config-search-row">
                    <input type="text" id="search-input" placeholder="æœç´¢é…ç½®åç§°(æ”¯æŒç©ºæ ¼åˆ†éš”å¤šä¸ªå…³é”®è¯)..." oninput="filterConfigs()">
                    <div class="search-toggle">
                        <div class="search-toggle-option active" data-mode="fuzzy" onclick="toggleSearchMode(this)">æ¨¡ç³Š</div>
                        <div class="search-toggle-option" data-mode="exact" onclick="toggleSearchMode(this)">ç²¾ç¡®</div>
                    </div>
                </div>
            </div>

            <div class="config-sort">
                <label>æ’åº:</label>
                <select id="sort-select" onchange="sortConfigs()">
                    <option value="time-desc">æ—¶é—´å€’åº</option>
                    <option value="time-asc">æ—¶é—´é¡ºåº</option>
                    <option value="name-asc">åç§° A-Z</option>
                    <option value="name-desc">åç§° Z-A</option>
                </select>
            </div>
            
            <div class="config-list" id="config-list"></div>
        </div>
    </div>

    <!-- æç¤ºæ¶ˆæ¯ -->
    <div class="toast" id="toast"></div>

    <!-- æ»šåŠ¨æŒ‰é’® -->
    <button class="scroll-btn scroll-to-top" id="scroll-to-top" onclick="scrollToTop()">â†‘</button>
    <button class="scroll-btn scroll-to-bottom" id="scroll-to-bottom" onclick="scrollToBottom()">â†“</button>

    <script>
        // è‡ªå®šä¹‰å­—æ®µè®¡æ•°å™¨
        let customFieldCounter = 0;
        
        // å­˜å‚¨çš„é…ç½®åˆ—è¡¨
        let savedConfigs = [];

        // å½“å‰æœç´¢è¯å’Œæ’åºæ–¹å¼
        let currentSearchTerm = '';
        let currentSortMode = 'time-desc';
        let previousSortMode = 'time-desc';

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            loadSavedConfigs();
            toggleModeOptions();
            setTimeout(() => {
                autoGenerate();
            }, 100);
            
            // ç›‘å¬æ»šåŠ¨äº‹ä»¶
            window.addEventListener('scroll', handleScroll);
        };

        // å¤„ç†æ»šåŠ¨æ˜¾ç¤º/éšè—æŒ‰é’®
        function handleScroll() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollHeight = document.documentElement.scrollHeight;
            const clientHeight = document.documentElement.clientHeight;
            
            const scrollToTopBtn = document.getElementById('scroll-to-top');
            const scrollToBottomBtn = document.getElementById('scroll-to-bottom');
            
            // æ»šåŠ¨è¶…è¿‡300pxæ˜¾ç¤ºå›é¡¶æŒ‰é’®
            if (scrollTop > 300) {
                scrollToTopBtn.classList.add('show');
            } else {
                scrollToTopBtn.classList.remove('show');
            }
            
            // è·ç¦»åº•éƒ¨è¶…è¿‡300pxæ˜¾ç¤ºå›åº•æŒ‰é’®
            if (scrollHeight - scrollTop - clientHeight > 300) {
                scrollToBottomBtn.classList.add('show');
            } else {
                scrollToBottomBtn.classList.remove('show');
            }
        }

        // æ»šåŠ¨åˆ°é¡¶éƒ¨
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            window.scrollTo({
                top: document.documentElement.scrollHeight,
                behavior: 'smooth'
            });
        }

        // åŠ è½½å·²ä¿å­˜çš„é…ç½®åˆ—è¡¨
        function loadSavedConfigs() {
            try {
                const saved = localStorage.getItem('theaterConfigList');
                if (saved) {
                    savedConfigs = JSON.parse(saved);
                }
            } catch (e) {
                console.error('åŠ è½½é…ç½®åˆ—è¡¨å¤±è´¥', e);
                savedConfigs = [];
            }
        }

        // ä¿å­˜é…ç½®åˆ—è¡¨åˆ°æœ¬åœ°å­˜å‚¨
        function saveSavedConfigs() {
            try {
                localStorage.setItem('theaterConfigList', JSON.stringify(savedConfigs));
            } catch (e) {
                console.error('ä¿å­˜é…ç½®åˆ—è¡¨å¤±è´¥', e);
            }
        }

        // æ‰“å¼€ä½¿ç”¨è¯´æ˜
        function openHelp() {
            document.getElementById('help-modal').classList.add('active');
        }

        // å…³é—­ä½¿ç”¨è¯´æ˜
        function closeHelp() {
            document.getElementById('help-modal').classList.remove('active');
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('help-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeHelp();
            }
        });

        document.getElementById('config-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeConfigList();
            }
        });

        // åˆ‡æ¢å­—æ®µå¼€å…³
        function toggleField(toggleElement) {
            toggleElement.classList.toggle('active');
            const formGroup = toggleElement.closest('.form-group, .custom-field');
            if (toggleElement.classList.contains('active')) {
                formGroup.classList.remove('disabled');
            } else {
                formGroup.classList.add('disabled');
            }
            autoGenerate();
        }

        // åˆ‡æ¢ä½¿ç”¨æ¨¡å¼é€‰é¡¹
        function toggleModeOptions() {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const customTagInput = document.getElementById('custom-tag-input');
            
            if (mode === 'custom') {
                customTagInput.style.display = 'block';
            } else {
                customTagInput.style.display = 'none';
            }
        }

        // åˆ‡æ¢ä¸–ç•Œè§‚è¾“å…¥æ¡†
        function toggleWorldviewInput() {
            const customRadio = document.querySelector('input[name="worldview"][value="custom"]');
            const customTextarea = document.getElementById('worldview-custom');
            customTextarea.disabled = !customRadio.checked;
            customTextarea.style.display = customRadio.checked ? 'block' : 'none';
        }

        // æ·»åŠ è‡ªå®šä¹‰å­—æ®µ
        function addCustomField() {
            customFieldCounter++;
            const container = document.getElementById('custom-fields-container');
            const fieldId = 'custom-field-' + customFieldCounter;
            
            const fieldHtml = `
                <div class="custom-field" id="${fieldId}" data-field-id="${customFieldCounter}">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <div class="custom-field-header" style="flex: 1; margin: 0;">
                            <h4>#${customFieldCounter}</h4>
                            <div class="custom-field-actions">
                                <button type="button" class="copy-field-btn" onclick="copyCustomField('${fieldId}')">ğŸ“‹</button>
                                <button type="button" class="move-up-btn" onclick="moveFieldUp('${fieldId}')">â†‘</button>
                                <button type="button" class="move-down-btn" onclick="moveFieldDown('${fieldId}')">â†“</button>
                                <button type="button" class="remove-field-btn" onclick="removeCustomField('${fieldId}')">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å­—æ®µåç§°</label>
                        <input type="text" class="field-name" placeholder="ä¾‹å¦‚:è§’è‰²å…³ç³»" oninput="autoGenerate()">
                    </div>
                    <div class="form-group">
                        <label>å­—æ®µç±»å‹</label>
                        <select class="field-type" onchange="updateFieldInput(this, '${fieldId}')">
                            <option value="text">æ–‡æœ¬æ¡†</option>
                            <option value="radio">å•é€‰</option>
                            <option value="checkbox">å¤šé€‰</option>
                            <option value="random">éšæœºæŠ½å–</option>
                        </select>
                    </div>
                    <div class="form-group field-input-container">
                        <label>å­—æ®µå†…å®¹</label>
                        <textarea class="field-content" placeholder="è¯·è¾“å…¥å†…å®¹" oninput="autoGenerate()"></textarea>
                        <div class="hint">å½“éœ€è¦åœ¨å¤šä¸ªé€‰é¡¹ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªæ—¶,è¯·é€‰æ‹©éšæœºå­—æ®µï¼Œå¹¶ç”¨è‹±æ–‡é€—å·åˆ†éš”ä¸åŒé€‰é¡¹ã€‚</div>
                    </div>
                    <div class="options-editor edit-mode" style="display: none;" data-mode="edit">
                        <label>é…ç½®é€‰é¡¹</label>
                        <div class="options-list"></div>
                        <button type="button" class="add-option-btn" onclick="addOption('${fieldId}')">+ æ·»åŠ é€‰é¡¹</button>
                        <div class="options-display"></div>
                        <button type="button" class="toggle-edit-btn" onclick="toggleEditMode('${fieldId}')">åº”ç”¨</button>
                    </div>
                    <div class="repeat-count" style="display: none;">
                        <label>éšæœºæ¬¡æ•°:</label>
                        <input type="number" class="field-repeat" value="1" min="1" max="99" oninput="autoGenerate()">
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', fieldHtml);
            autoGenerate();
        }

        // å¤åˆ¶è‡ªå®šä¹‰å­—æ®µ
        function copyCustomField(fieldId) {
            const sourceField = document.getElementById(fieldId);
            const fieldData = extractFieldData(sourceField);
            
            // åˆ›å»ºæ–°å­—æ®µ
            addCustomField();
            const newFieldId = 'custom-field-' + customFieldCounter;
            const newField = document.getElementById(newFieldId);
            
            // åº”ç”¨æ•°æ®
            applyFieldData(newField, fieldData, newFieldId);
            
            showToast('å­—æ®µå¤åˆ¶æˆåŠŸ!');
        }

        // æå–å­—æ®µæ•°æ®
        function extractFieldData(field) {
            const toggle = field.querySelector('.toggle-switch');
            const fieldType = field.querySelector('.field-type').value;
            const data = {
                name: field.querySelector('.field-name').value,
                type: fieldType,
                enabled: toggle.classList.contains('active'),
                repeat: field.querySelector('.field-repeat').value
            };
            
            if (fieldType === 'text' || fieldType === 'random') {
                data.content = field.querySelector('.field-content').value;
            } else if (fieldType === 'radio' || fieldType === 'checkbox') {
                data.options = [];
                field.querySelectorAll('.option-item input').forEach(input => {
                    if (input.value.trim()) {
                        data.options.push(input.value.trim());
                    }
                });
                const optionsEditor = field.querySelector('.options-editor');
                data.editMode = optionsEditor.getAttribute('data-mode') === 'edit';
            }
            
            return data;
        }

        // åº”ç”¨å­—æ®µæ•°æ®
        function applyFieldData(field, data, fieldId) {
            field.querySelector('.field-name').value = data.name;
            field.querySelector('.field-type').value = data.type;
            field.querySelector('.field-repeat').value = data.repeat;
            
            const toggle = field.querySelector('.toggle-switch');
            if (data.enabled) {
                toggle.classList.add('active');
                field.classList.remove('disabled');
            } else {
                toggle.classList.remove('active');
                field.classList.add('disabled');
            }
            
            updateFieldInput(field.querySelector('.field-type'), fieldId);
            
            if (data.type === 'text' || data.type === 'random') {
                field.querySelector('.field-content').value = data.content || '';
            } else if ((data.type === 'radio' || data.type === 'checkbox') && data.options) {
                const optionsList = field.querySelector('.options-list');
                optionsList.innerHTML = '';
                data.options.forEach(opt => {
                    addOptionItem(optionsList, opt, fieldId);
                });
                
                const optionsEditor = field.querySelector('.options-editor');
                if (data.editMode === false) {
                    toggleEditMode(fieldId);
                }
            }
        }

        // åˆ é™¤è‡ªå®šä¹‰å­—æ®µ
        function removeCustomField(fieldId) {
            document.getElementById(fieldId).remove();
            autoGenerate();
        }

        // ä¸Šç§»å­—æ®µ
        function moveFieldUp(fieldId) {
            const field = document.getElementById(fieldId);
            const prev = field.previousElementSibling;
            if (prev) {
                field.parentNode.insertBefore(field, prev);
                autoGenerate();
            }
        }

        // ä¸‹ç§»å­—æ®µ
        function moveFieldDown(fieldId) {
            const field = document.getElementById(fieldId);
            const next = field.nextElementSibling;
            if (next) {
                field.parentNode.insertBefore(next, field);
                autoGenerate();
            }
        }

        // æ›´æ–°å­—æ®µè¾“å…¥æ–¹å¼
        function updateFieldInput(select, fieldId) {
            const field = document.getElementById(fieldId);
            const repeatCountDiv = field.querySelector('.repeat-count');
            const contentContainer = field.querySelector('.field-input-container');
            const optionsEditor = field.querySelector('.options-editor');
            const fieldType = select.value;
            
            // éšè—æ‰€æœ‰
            repeatCountDiv.style.display = 'none';
            contentContainer.style.display = 'none';
            optionsEditor.style.display = 'none';
            
            if (fieldType === 'random') {
                contentContainer.style.display = 'block';
                repeatCountDiv.style.display = 'flex';
            } else if (fieldType === 'text') {
                contentContainer.style.display = 'block';
            } else if (fieldType === 'radio' || fieldType === 'checkbox') {
                optionsEditor.style.display = 'block';
                
                // ä¿æŒä¹‹å‰çš„æ¨¡å¼
                const currentMode = optionsEditor.getAttribute('data-mode');
                if (!currentMode || currentMode === 'edit') {
                    optionsEditor.classList.remove('view-mode');
                    optionsEditor.classList.add('edit-mode');
                    optionsEditor.setAttribute('data-mode', 'edit');
                } else {
                    optionsEditor.classList.remove('edit-mode');
                    optionsEditor.classList.add('view-mode');
                }
                
                renderOptionsEditor(fieldId, fieldType);
            }
            
            autoGenerate();
        }

        // æ¸²æŸ“é€‰é¡¹ç¼–è¾‘å™¨
        function renderOptionsEditor(fieldId, fieldType) {
            const field = document.getElementById(fieldId);
            const optionsEditor = field.querySelector('.options-editor');
            const optionsList = optionsEditor.querySelector('.options-list');
            
            // è·å–ç°æœ‰é€‰é¡¹æˆ–åˆ›å»ºé»˜è®¤é€‰é¡¹
            let options = [];
            const existingOptions = optionsList.querySelectorAll('.option-item input');
            if (existingOptions.length > 0) {
                existingOptions.forEach(input => {
                    if (input.value.trim()) {
                        options.push(input.value.trim());
                    }
                });
            }
            
            if (options.length === 0) {
                options = ['é€‰é¡¹1', 'é€‰é¡¹2'];
            }
            
            optionsList.innerHTML = '';
            options.forEach((opt, index) => {
                addOptionItem(optionsList, opt, fieldId);
            });
        }

        // æ·»åŠ é€‰é¡¹é¡¹
        function addOptionItem(container, value = '', fieldId) {
            const optionHtml = `
                <div class="option-item">
                    <input type="text" value="${value}" placeholder="é€‰é¡¹å†…å®¹" oninput="autoGenerate()">
                    <button type="button" onclick="removeOption(this, '${fieldId}')">åˆ é™¤</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', optionHtml);
        }

        // æ·»åŠ é€‰é¡¹
        function addOption(fieldId) {
            const field = document.getElementById(fieldId);
            const optionsList = field.querySelector('.options-list');
            addOptionItem(optionsList, '', fieldId);
            autoGenerate();
        }

        // åˆ é™¤é€‰é¡¹
        function removeOption(btn, fieldId) {
            const field = document.getElementById(fieldId);
            const optionsList = field.querySelector('.options-list');
            if (optionsList.children.length > 1) {
                btn.closest('.option-item').remove();
                autoGenerate();
            } else {
                showToast('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªé€‰é¡¹', 'error');
            }
        }

        // åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
        function toggleEditMode(fieldId) {
            const field = document.getElementById(fieldId);
            const optionsEditor = field.querySelector('.options-editor');
            const toggleBtn = optionsEditor.querySelector('.toggle-edit-btn');
            const optionsDisplay = optionsEditor.querySelector('.options-display');
            const fieldType = field.querySelector('.field-type').value;
            
            if (optionsEditor.classList.contains('edit-mode')) {
                // åˆ‡æ¢åˆ°æŸ¥çœ‹æ¨¡å¼
                optionsEditor.classList.remove('edit-mode');
                optionsEditor.classList.add('view-mode');
                optionsEditor.setAttribute('data-mode', 'view');
                toggleBtn.textContent = 'ç¼–è¾‘';
                
                // æ˜¾ç¤ºé€‰é¡¹
                const options = [];
                field.querySelectorAll('.option-item input').forEach(input => {
                    if (input.value.trim()) {
                        options.push(input.value.trim());
                    }
                });
                
                if (fieldType === 'radio') {
                    optionsDisplay.innerHTML = '<div class="radio-group">' + 
                        options.map((opt, idx) => `
                            <label>
                                <input type="radio" name="${fieldId}-display" ${idx === 0 ? 'checked' : ''} onchange="autoGenerate()">
                                ${opt}
                            </label>
                        `).join('') + '</div>';
                } else {
                    optionsDisplay.innerHTML = '<div class="radio-group">' + 
                        options.map(opt => `
                            <label>
                                <input type="checkbox" onchange="autoGenerate()">
                                ${opt}
                            </label>
                        `).join('') + '</div>';
                }
            } else {
                // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
                optionsEditor.classList.remove('view-mode');
                optionsEditor.classList.add('edit-mode');
                optionsEditor.setAttribute('data-mode', 'edit');
                toggleBtn.textContent = 'åº”ç”¨';
            }
            
            autoGenerate();
        }

        // è‡ªåŠ¨ç”Ÿæˆè¾“å‡ºå†…å®¹
        function autoGenerate() {
            let output = '';
            
            // è·å–è¡¨å•å€¼
            const titleField = document.querySelector('[data-field="title"]');
            const titleEnabled = !titleField.classList.contains('disabled');
            const title = document.getElementById('title').value.trim();
            
            const modeField = document.querySelector('[data-field="mode"]');
            const modeEnabled = !modeField.classList.contains('disabled');
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const customTag = document.getElementById('custom-tag').value.trim() || 'little-play';
            
            const requirementsField = document.querySelector('[data-field="requirements"]');
            const requirementsEnabled = !requirementsField.classList.contains('disabled');
            const requirements = document.getElementById('requirements').value.trim();
            
            const backgroundField = document.querySelector('[data-field="background"]');
            const backgroundEnabled = !backgroundField.classList.contains('disabled');
            const background = document.getElementById('background').value.trim();
            
            const styleField = document.querySelector('[data-field="style"]');
            const styleEnabled = !styleField.classList.contains('disabled');
            const style = document.getElementById('style').value.trim();
            
            const worldviewField = document.querySelector('[data-field="worldview"]');
            const worldviewEnabled = !worldviewField.classList.contains('disabled');
            const worldviewMode = document.querySelector('input[name="worldview"]:checked').value;
            const worldviewCustom = document.getElementById('worldview-custom').value.trim();
            
            const lengthField = document.querySelector('[data-field="length"]');
            const lengthEnabled = !lengthField.classList.contains('disabled');
            const length = document.getElementById('length').value;
            
            const genreField = document.querySelector('[data-field="genre"]');
            const genreEnabled = !genreField.classList.contains('disabled');
            const genre = document.getElementById('genre').value.trim();
            
            const elementsField = document.querySelector('[data-field="elements"]');
            const elementsEnabled = !elementsField.classList.contains('disabled');
            const elements = document.getElementById('elements').value.trim();
            const elementsRepeat = parseInt(document.getElementById('elements-repeat').value);

            // æ ¹æ®ä½¿ç”¨æ¨¡å¼æ·»åŠ å¼€å§‹æ ‡ç­¾
            if (modeEnabled) {
                if (mode === 'worldbook') {
                    output += '<little-play>\n';
                } else if (mode === 'puppy') {
                    output += '<small_theater>\n';
                } else if (mode === 'custom') {
                    output += `<${customTag}>\n`;
                }
            }

            // æ ‡é¢˜
            if (titleEnabled && title) {
                output += `ã€å°å‰§åœºÂ·${title}ã€‘\næ•´ä½“è¦æ±‚:\n`;
            }

            // ä½¿ç”¨æ¨¡å¼
            if (modeEnabled && mode === 'independent') {
                output += '- æœ¬æ¬¡å›å¤éœ€æš‚åœä¸€åˆ‡æ­£æ–‡è¾“å‡º,ç«‹åˆ»è¾“å‡ºæœ¬å‰§åœºå†…å®¹ã€‚\n';
            }

            // ç”Ÿæˆè¦æ±‚
            if (requirementsEnabled && requirements) {
                output += requirements + '\n';
            }

            // å›ºå®šè¦æ±‚
            output += '- å°å‰§åœºæ ‡é¢˜éœ€æ ¹æ®å†…å®¹åŠ¨æ€ç”Ÿæˆã€‚\n';
            output += '- å‰§æƒ…å¿…é¡»å®Œæ•´,ä»å¼€å¤´åˆ°ç»“å°¾,ä¸èƒ½ä»…æ˜¯å‰§æƒ…ç‰‡æ®µã€‚\n';

            // æ•…äº‹èƒŒæ™¯
            if (backgroundEnabled && background) {
                output += `- æ•…äº‹èƒŒæ™¯: {{random:${background}}}\n`;
            }

            // æ–‡é£è¦æ±‚
            if (styleEnabled && style) {
                output += `- æ–‡é£: {{random:${style}}}\n`;
            }

            // ä¸–ç•Œè§‚&é¢˜æ
            if (worldviewEnabled) {
                if (worldviewMode === 'consistent') {
                    output += '- å‰§åœºå†…å®¹æ ¹æ®ä¸»çº¿å‰§æƒ…å’Œå½“å‰ä¸–ç•Œè§‚åŠ¨æ€é€‚é…ã€‚\n';
                } else if (worldviewCustom) {
                    output += `- ä¸–ç•Œè§‚&é¢˜æ: {{random:${worldviewCustom}}}\n`;
                }
            }

            // ç¯‡å¹…è¦æ±‚
            if (lengthEnabled && length) {
                output += `- ç¯‡å¹…: â‰¥${length}å­—\n`;
            }

            // ä½“è£è¦æ±‚
            if (genreEnabled && genre) {
                output += `- ä½“è£: {{random:${genre}}}\n`;
            }

            // å…ƒç´ è¦æ±‚
            if (elementsEnabled && elements) {
                output += '- å…ƒç´ è¦æ±‚: ';
                const elementParts = [];
                for (let i = 0; i < elementsRepeat; i++) {
                    elementParts.push(`{{random:${elements}}}`);
                }
                output += elementParts.join(';') + '\n';
            }

            // è‡ªå®šä¹‰å­—æ®µ
            const customFields = document.querySelectorAll('.custom-field');
            customFields.forEach(field => {
                const toggle = field.querySelector('.toggle-switch');
                const isEnabled = toggle.classList.contains('active');
                
                if (!isEnabled) return;
                
                const name = field.querySelector('.field-name').value.trim();
                const type = field.querySelector('.field-type').value;
                
                if (!name) return;
                
                if (type === 'text') {
                    const content = field.querySelector('.field-content').value.trim();
                    if (content) {
                        output += `- ${name}: ${content}\n`;
                    }
                } else if (type === 'random') {
                    const content = field.querySelector('.field-content').value.trim();
                    const repeat = parseInt(field.querySelector('.field-repeat').value);
                    if (content) {
                        output += `- ${name}: `;
                        const parts = [];
                        for (let i = 0; i < repeat; i++) {
                            parts.push(`{{random:${content}}}`);
                        }
                        output += parts.join(';') + '\n';
                    }
                } else if (type === 'radio') {
                    const optionsEditor = field.querySelector('.options-editor');
                    if (optionsEditor.classList.contains('view-mode')) {
                        const selectedRadio = field.querySelector('input[type="radio"]:checked');
                        if (selectedRadio) {
                            const selectedText = selectedRadio.parentElement.textContent.trim();
                            output += `- ${name}: ${selectedText}\n`;
                        }
                    } else {
                        const options = [];
                        field.querySelectorAll('.option-item input').forEach(input => {
                            if (input.value.trim()) {
                                options.push(input.value.trim());
                            }
                        });
                        if (options.length > 0) {
                            output += `- ${name}: {{random:${options.join(',')}}}\n`;
                        }
                    }
                } else if (type === 'checkbox') {
                    const optionsEditor = field.querySelector('.options-editor');
                    if (optionsEditor.classList.contains('view-mode')) {
                        const selected = [];
                        field.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                            selected.push(checkbox.parentElement.textContent.trim());
                        });
                        if (selected.length > 0) {
                            output += `- ${name}: ${selected.join(',')}\n`;
                        }
                    } else {
                        const options = [];
                        field.querySelectorAll('.option-item input').forEach(input => {
                            if (input.value.trim()) {
                                options.push(input.value.trim());
                            }
                        });
                        if (options.length > 0) {
                            output += `- ${name}: ${options.join(',')}\n`;
                        }
                    }
                }
            });

            // æ ¹æ®ä½¿ç”¨æ¨¡å¼æ·»åŠ ç»“æŸæ ‡ç­¾
            if (modeEnabled) {
                if (mode === 'worldbook') {
                    output += '</little-play>';
                } else if (mode === 'puppy') {
                    output += '</small_theater>';
                } else if (mode === 'custom') {
                    output += `</${customTag}>`;
                }
            }

            // æ˜¾ç¤ºè¾“å‡º
            document.getElementById('output').textContent = output;
        }

        // ç”Ÿæˆéšæœºé¢„è§ˆ
        function generatePreview() {
            const output = document.getElementById('output').textContent;
            if (!output) {
                showToast('è¯·å…ˆç”Ÿæˆå†…å®¹', 'error');
                return;
            }
            
            // è§£æå¹¶æ›¿æ¢æ‰€æœ‰{{random:...}}
            let preview = parseRandomSyntax(output);
            
            document.getElementById('preview').textContent = preview;
        }

        // è§£æ{{random:...}}è¯­æ³•ï¼ˆæ”¯æŒåµŒå¥—{{}}å’Œæ¢è¡Œï¼‰
        function parseRandomSyntax(text) {
            let result = text;
            let maxIterations = 100; // é˜²æ­¢æ— é™å¾ªç¯
            let iteration = 0;
            
            while (iteration < maxIterations) {
                let changed = false;
                let newResult = '';
                let i = 0;
                
                while (i < result.length) {
                    // æŸ¥æ‰¾{{random:
                    if (i <= result.length - 9 && result.substring(i, i + 9) === '{{random:') {
                        // æ‰¾åˆ°åŒ¹é…çš„ç»“æŸ}}
                        let depth = 2; // å·²ç»æœ‰ä¸¤ä¸ª{
                        let start = i + 9;
                        let j = start;
                        
                        while (j < result.length && depth > 0) {
                            if (result[j] === '{') {
                                depth++;
                            } else if (result[j] === '}') {
                                depth--;
                            }
                            j++;
                        }
                        
                        if (depth === 0) {
                            // æ‰¾åˆ°äº†åŒ¹é…çš„}}
                            const content = result.substring(start, j - 2);
                            
                            // æŒ‰é€—å·åˆ†éš”é€‰é¡¹ï¼ˆéœ€è¦è€ƒè™‘åµŒå¥—çš„{{}}å’Œæ¢è¡Œï¼‰
                            const options = smartSplit(content, ',');
                            
                            if (options.length > 0) {
                                // éšæœºé€‰æ‹©ä¸€ä¸ª
                                const randomIndex = Math.floor(Math.random() * options.length);
                                newResult += options[randomIndex];
                                changed = true;
                            } else {
                                newResult += result.substring(i, j);
                            }
                            i = j;
                        } else {
                            // æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç»“æŸï¼Œä¿æŒåŸæ ·
                            newResult += result[i];
                            i++;
                        }
                    } else {
                        newResult += result[i];
                        i++;
                    }
                }
                
                result = newResult;
                if (!changed) break;
                iteration++;
            }
            
            return result;
        }

        // æ™ºèƒ½åˆ†å‰²å­—ç¬¦ä¸²ï¼ˆè€ƒè™‘{{}}åµŒå¥—å’Œæ¢è¡Œï¼‰
        function smartSplit(text, delimiter) {
            const result = [];
            let current = '';
            let depth = 0;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                
                if (char === '{') {
                    depth++;
                    current += char;
                } else if (char === '}') {
                    depth--;
                    current += char;
                } else if (char === delimiter && depth === 0) {
                    // æ‰¾åˆ°åˆ†éš”ç¬¦ï¼Œä¿å­˜å½“å‰é¡¹
                    const trimmed = current.trim();
                    if (trimmed) {
                        result.push(trimmed);
                    }
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // æ·»åŠ æœ€åä¸€é¡¹
            const trimmed = current.trim();
            if (trimmed) {
                result.push(trimmed);
            }
            
            return result.length > 0 ? result : [text.trim()];
        }

        // å¤åˆ¶è¾“å‡ºå†…å®¹
        function copyOutput() {
            const output = document.getElementById('output').textContent;
            if (!output) {
                showToast('æ²¡æœ‰å†…å®¹å¯å¤åˆ¶', 'error');
                return;
            }

            navigator.clipboard.writeText(output).then(() => {
                showToast('å¤åˆ¶æˆåŠŸ!');
            }).catch(() => {
                showToast('å¤åˆ¶å¤±è´¥,è¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // å¤åˆ¶é¢„è§ˆå†…å®¹
        function copyPreview() {
            const preview = document.getElementById('preview').textContent;
            if (!preview) {
                showToast('æ²¡æœ‰é¢„è§ˆå†…å®¹å¯å¤åˆ¶', 'error');
                return;
            }

            navigator.clipboard.writeText(preview).then(() => {
                showToast('é¢„è§ˆå†…å®¹å¤åˆ¶æˆåŠŸ!');
            }).catch(() => {
                showToast('å¤åˆ¶å¤±è´¥,è¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = type === 'success' ? '#10b981' : '#ef4444';
            toast.classList.add('active');
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }

        // ä¿å­˜å½“å‰é…ç½®
        function saveCurrentConfig() {
            const title = document.getElementById('title').value.trim() || 'æœªå‘½å';
            const now = new Date();
            const timeStr = now.getFullYear() + 
                            String(now.getMonth() + 1).padStart(2, '0') + 
                            String(now.getDate()).padStart(2, '0') + '_' +
                            String(now.getHours()).padStart(2, '0') + 
                            String(now.getMinutes()).padStart(2, '0') + 
                            String(now.getSeconds()).padStart(2, '0');
            
            const configName = `${title}_${timeStr}`;
            
            const config = collectConfig();
            config.name = configName;
            config.timestamp = now.getTime();
            config.id = now.getTime().toString();
            
            // æ£€æŸ¥æ˜¯å¦è¶…è¿‡99ä¸ª
            if (savedConfigs.length >= 99) {
                showToast('é…ç½®æ•°é‡å·²è¾¾ä¸Šé™(99ä¸ª)', 'error');
                return;
            }
            
            savedConfigs.unshift(config);
            saveSavedConfigs();
            showToast('é…ç½®ä¿å­˜æˆåŠŸ!');
        }

        // æ‰“å¼€é…ç½®åˆ—è¡¨
        function openConfigList() {
            currentSearchTerm = '';
            document.getElementById('search-input').value = '';
            document.getElementById('sort-select').value = previousSortMode;
            currentSortMode = previousSortMode;
            renderConfigList();
            document.getElementById('config-modal').classList.add('active');
        }

        // å…³é—­é…ç½®åˆ—è¡¨
        function closeConfigList() {
            document.getElementById('config-modal').classList.remove('active');
        }

        // åˆ‡æ¢æœç´¢æ¨¡å¼
        function toggleSearchMode(element) {
            document.querySelectorAll('.search-toggle-option').forEach(opt => {
                opt.classList.remove('active');
            });
            element.classList.add('active');
            filterConfigs();
        }

        // è¿‡æ»¤é…ç½®
        function filterConfigs() {
            const searchTerm = document.getElementById('search-input').value.trim();
            const searchMode = document.querySelector('.search-toggle-option.active').getAttribute('data-mode');
            
            currentSearchTerm = searchTerm;
            
            if (!searchTerm) {
                // æ¢å¤ä¹‹å‰çš„æ’åº
                currentSortMode = previousSortMode;
                document.getElementById('sort-select').value = previousSortMode;
                renderConfigList();
                return;
            }
            
            // æŒ‰ç©ºæ ¼åˆ†éš”å…³é”®è¯
            const keywords = searchTerm.split(/\s+/).filter(k => k);
            
            let filtered = savedConfigs.filter(config => {
                if (searchMode === 'exact') {
                    // ç²¾ç¡®æœç´¢:å¿…é¡»åŒ…å«æ‰€æœ‰å…³é”®è¯
                    return keywords.every(keyword => config.name.includes(keyword));
                } else {
                    // æ¨¡ç³Šæœç´¢:åŒ…å«ä»»ä¸€å…³é”®è¯å³å¯
                    return keywords.some(keyword => config.name.includes(keyword));
                }
            });

            // æœç´¢æ—¶çš„ç‰¹æ®Šæ’åº
            filtered = filtered.map(config => {
                // è®¡ç®—åŒ¹é…åº¦
                let matchScore = 0;
                keywords.forEach(keyword => {
                    const index = config.name.indexOf(keyword);
                    if (index !== -1) {
                        // ä½ç½®è¶Šé å‰å¾—åˆ†è¶Šé«˜
                        matchScore += (1000 - index);
                        // å…³é”®è¯é•¿åº¦è¶Šé•¿å¾—åˆ†è¶Šé«˜
                        matchScore += keyword.length * 10;
                    }
                });
                return { ...config, matchScore };
            });

            // æ’åº: 1. åŒ¹é…åº¦ 2. æ—¶é—´å€’åº 3. åç§°A-Z
            filtered.sort((a, b) => {
                if (a.matchScore !== b.matchScore) {
                    return b.matchScore - a.matchScore;
                }
                if (a.timestamp !== b.timestamp) {
                    return b.timestamp - a.timestamp;
                }
                return a.name.localeCompare(b.name, 'zh-CN');
            });
            
            renderConfigList(filtered, true);
        }

        // æ’åºé…ç½®
        function sortConfigs() {
            const sortMode = document.getElementById('sort-select').value;
            currentSortMode = sortMode;
            
            // åªæœ‰åœ¨éæœç´¢çŠ¶æ€ä¸‹æ‰ä¿å­˜ä¸ºé»˜è®¤æ’åº
            if (!currentSearchTerm) {
                previousSortMode = sortMode;
            }
            
            renderConfigList();
        }

        // æ¸²æŸ“é…ç½®åˆ—è¡¨
        function renderConfigList(filteredConfigs = null, isSearchResult = false) {
            const configList = document.getElementById('config-list');
            let configs = filteredConfigs || [...savedConfigs];
            
            // å¦‚æœä¸æ˜¯æœç´¢ç»“æœ,åº”ç”¨ç”¨æˆ·é€‰æ‹©çš„æ’åº
            if (!isSearchResult) {
                const sortMode = currentSortMode;
                
                configs.sort((a, b) => {
                    switch(sortMode) {
                        case 'time-desc':
                            return b.timestamp - a.timestamp;
                        case 'time-asc':
                            return a.timestamp - b.timestamp;
                        case 'name-asc':
                            return a.name.localeCompare(b.name, 'zh-CN');
                        case 'name-desc':
                            return b.name.localeCompare(a.name, 'zh-CN');
                        default:
                            return b.timestamp - a.timestamp;
                    }
                });
            }
            
            if (configs.length === 0) {
                const message = isSearchResult ? 'æ— åŒ¹é…ç»“æœ' : 'æš‚æ— ä¿å­˜çš„é…ç½®';
                configList.innerHTML = `<div class="no-results">${message}</div>`;
                return;
            }
            
            configList.innerHTML = '';
            configs.forEach((config, index) => {
                const date = new Date(config.timestamp);
                const dateStr = date.toLocaleString('zh-CN');
                
                const configHtml = `
                    <div class="config-item">
                        <div style="flex: 1;">
                            <div class="config-name" contenteditable="false" data-config-id="${config.id}" onclick="loadConfig('${config.id}')">${config.name}</div>
                            <div class="config-time">${dateStr}</div>
                        </div>
                        <div class="config-actions">
                            <button class="rename-btn" onclick="renameConfig('${config.id}', event)">é‡å‘½å</button>
                            <button class="delete-btn" onclick="deleteConfig('${config.id}')">åˆ é™¤</button>
                        </div>
                    </div>
                `;
                configList.insertAdjacentHTML('beforeend', configHtml);
            });
        }

        // åŠ è½½é…ç½®
        function loadConfig(configId) {
            const nameEl = document.querySelector(`[data-config-id="${configId}"]`);
            if (nameEl && nameEl.contentEditable === 'true') {
                return; // æ­£åœ¨ç¼–è¾‘ä¸­,ä¸åŠ è½½
            }
            
            const config = savedConfigs.find(c => c.id === configId);
            if (!config) return;
            
            applyConfig(config);
            closeConfigList();
            showToast('é…ç½®åŠ è½½æˆåŠŸ!');
        }

        // é‡å‘½åé…ç½®
        function renameConfig(configId, event) {
            event.stopPropagation();
            const nameEl = document.querySelector(`[data-config-id="${configId}"]`);
            
            if (nameEl.contentEditable === 'true') {
                // ä¿å­˜é‡å‘½å
                nameEl.contentEditable = 'false';
                nameEl.classList.remove('editing');
                
                const config = savedConfigs.find(c => c.id === configId);
                if (config) {
                    config.name = nameEl.textContent.trim() || config.name;
                    saveSavedConfigs();
                    showToast('é‡å‘½åæˆåŠŸ!');
                }
                
                event.target.textContent = 'é‡å‘½å';
            } else {
                // å¼€å§‹ç¼–è¾‘
                nameEl.contentEditable = 'true';
                nameEl.classList.add('editing');
                nameEl.focus();
                
                // é€‰ä¸­æ–‡æœ¬
                const range = document.createRange();
                range.selectNodeContents(nameEl);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                
                event.target.textContent = 'ä¿å­˜';
            }
        }

        // åˆ é™¤é…ç½®
        function deleteConfig(configId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…ç½®å—?')) return;
            
            savedConfigs = savedConfigs.filter(c => c.id !== configId);
            saveSavedConfigs();
            
            // é‡æ–°è¿‡æ»¤å’Œæ¸²æŸ“
            if (currentSearchTerm) {
                filterConfigs();
            } else {
                renderConfigList();
            }
            showToast('é…ç½®å·²åˆ é™¤');
        }

        // æ”¶é›†å½“å‰é…ç½®
        function collectConfig() {
            const config = {
                title: document.getElementById('title').value,
                mode: document.querySelector('input[name="mode"]:checked').value,
                customTag: document.getElementById('custom-tag').value,
                requirements: document.getElementById('requirements').value,
                background: document.getElementById('background').value,
                style: document.getElementById('style').value,
                worldviewMode: document.querySelector('input[name="worldview"]:checked').value,
                worldviewCustom: document.getElementById('worldview-custom').value,
                length: document.getElementById('length').value,
                genre: document.getElementById('genre').value,
                elements: document.getElementById('elements').value,
                elementsRepeat: document.getElementById('elements-repeat').value,
                fieldToggles: {},
                customFields: []
            };

            // æ”¶é›†å­—æ®µå¼€å…³çŠ¶æ€
            document.querySelectorAll('[data-field]').forEach(field => {
                const fieldName = field.getAttribute('data-field');
                const toggle = field.querySelector('.toggle-switch');
                config.fieldToggles[fieldName] = toggle.classList.contains('active');
            });

            // æ”¶é›†è‡ªå®šä¹‰å­—æ®µ
            const customFields = document.querySelectorAll('.custom-field');
            customFields.forEach(field => {
                const fieldData = extractFieldData(field);
                config.customFields.push(fieldData);
            });

            return config;
        }

        // åº”ç”¨é…ç½®
        function applyConfig(config) {
            document.getElementById('title').value = config.title || 'ç•ªå¤–';
            document.querySelector(`input[name="mode"][value="${config.mode}"]`).checked = true;
            document.getElementById('custom-tag').value = config.customTag || 'little-play';
            toggleModeOptions();
            document.getElementById('requirements').value = config.requirements || '';
            document.getElementById('background').value = config.background || '';
            document.getElementById('style').value = config.style || '';
            document.querySelector(`input[name="worldview"][value="${config.worldviewMode}"]`).checked = true;
            document.getElementById('worldview-custom').value = config.worldviewCustom || '';
            toggleWorldviewInput();
            document.getElementById('length').value = config.length || '2000';
            document.getElementById('genre').value = config.genre || '';
            document.getElementById('elements').value = config.elements || '';
            document.getElementById('elements-repeat').value = config.elementsRepeat || '1';

            // åº”ç”¨å­—æ®µå¼€å…³çŠ¶æ€
            if (config.fieldToggles) {
                Object.keys(config.fieldToggles).forEach(fieldName => {
                    const field = document.querySelector(`[data-field="${fieldName}"]`);
                    if (field) {
                        const toggle = field.querySelector('.toggle-switch');
                        if (config.fieldToggles[fieldName]) {
                            toggle.classList.add('active');
                            field.classList.remove('disabled');
                        } else {
                            toggle.classList.remove('active');
                            field.classList.add('disabled');
                        }
                    }
                });
            }

            // æ¸…ç©ºå¹¶é‡å»ºè‡ªå®šä¹‰å­—æ®µ
            document.getElementById('custom-fields-container').innerHTML = '';
            customFieldCounter = 0;
            
            if (config.customFields && config.customFields.length > 0) {
                config.customFields.forEach(fieldData => {
                    addCustomField();
                    const fieldId = 'custom-field-' + customFieldCounter;
                    const fieldElement = document.getElementById(fieldId);
                    applyFieldData(fieldElement, fieldData, fieldId);
                });
            }
            
            autoGenerate();
        }

        // å¯¼å‡ºé…ç½®
        function exportConfig(format) {
            if (format === 'json') {
                const config = collectConfig();
                const title = document.getElementById('title').value.trim() || 'æœªå‘½å';
                const now = new Date();
                const timeStr = now.getFullYear() + 
                                String(now.getMonth() + 1).padStart(2, '0') + 
                                String(now.getDate()).padStart(2, '0') + '_' +
                                String(now.getHours()).padStart(2, '0') + 
                                String(now.getMinutes()).padStart(2, '0') + 
                                String(now.getSeconds()).padStart(2, '0');
                const timestamp = now.getTime();
                
                const dataStr = JSON.stringify(config, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `å°å‰§åœºé…ç½®_${title}_${timeStr}_${timestamp}.json`;
                link.click();
                URL.revokeObjectURL(url);
                showToast('JSONé…ç½®å¯¼å‡ºæˆåŠŸ!');
            } else if (format === 'txt') {
                const output = document.getElementById('output').textContent;
                if (!output) {
                    showToast('æ²¡æœ‰å†…å®¹å¯å¯¼å‡º', 'error');
                    return;
                }
                const title = document.getElementById('title').value.trim() || 'æœªå‘½å';
                const now = new Date();
                const timeStr = now.getFullYear() + 
                                String(now.getMonth() + 1).padStart(2, '0') + 
                                String(now.getDate()).padStart(2, '0') + '_' +
                                String(now.getHours()).padStart(2, '0') + 
                                String(now.getMinutes()).padStart(2, '0') + 
                                String(now.getSeconds()).padStart(2, '0');
                const timestamp = now.getTime();
                
                const blob = new Blob([output], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `å°å‰§åœºé…ç½®_${title}_${timeStr}_${timestamp}.txt`;
                link.click();
                URL.revokeObjectURL(url);
                showToast('TXTæ–‡æœ¬å¯¼å‡ºæˆåŠŸ!');
            }
        }

        // å¯¼å…¥é…ç½®
        function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    if (fileName.endsWith('.json')) {
                        // JSONæ ¼å¼å¯¼å…¥
                        const config = JSON.parse(content);
                        applyConfig(config);
                        showToast('é…ç½®å¯¼å…¥æˆåŠŸ!');
                    } else if (fileName.endsWith('.txt')) {
                        // TXTæ ¼å¼å¯¼å…¥
                        parseTxtConfig(content);
                        showToast('TXTé…ç½®å¯¼å…¥æˆåŠŸ!');
                    } else {
                        showToast('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼', 'error');
                    }
                } catch (error) {
                    console.error(error);
                    showToast('å¯¼å…¥å¤±è´¥,æ–‡ä»¶æ ¼å¼é”™è¯¯', 'error');
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }

        // è§£æTXTé…ç½®
        function parseTxtConfig(content) {
            const config = {
                fieldToggles: {},
                customFields: []
            };
            
            // æå–æ ‡é¢˜
            const titleMatch = content.match(/ã€å°å‰§åœºÂ·(.+?)ã€‘/);
            if (titleMatch) {
                config.title = titleMatch[1];
            }
            
            // åˆ¤æ–­ä½¿ç”¨æ¨¡å¼
            if (content.startsWith('<little-play>')) {
                config.mode = 'worldbook';
            } else if (content.startsWith('<puppy>')) {
                config.mode = 'puppy';
            } else if (content.match(/^<(.+?)>/)) {
                config.mode = 'custom';
                const tagMatch = content.match(/^<(.+?)>/);
                config.customTag = tagMatch[1];
            } else {
                config.mode = 'independent';
            }
            
            // æå–ç”Ÿæˆè¦æ±‚
            let reqStart = content.indexOf('æ•´ä½“è¦æ±‚:');
            if (config.mode === 'independent') {
                reqStart = content.indexOf('- æœ¬æ¬¡å›å¤éœ€æš‚åœä¸€åˆ‡æ­£æ–‡è¾“å‡º,ç«‹åˆ»è¾“å‡ºæœ¬å‰§åœºå†…å®¹ã€‚');
                if (reqStart !== -1) {
                    reqStart = content.indexOf('\n', reqStart) + 1;
                }
            } else {
                if (reqStart !== -1) {
                    reqStart = content.indexOf('\n', reqStart) + 1;
                }
            }
            
            const reqEnd = content.indexOf('- å°å‰§åœºæ ‡é¢˜éœ€æ ¹æ®å†…å®¹åŠ¨æ€ç”Ÿæˆã€‚');
            if (reqStart !== -1 && reqEnd !== -1) {
                config.requirements = content.substring(reqStart, reqEnd).trim();
            }
            
            // æå–å…¶ä»–å­—æ®µ
            const lines = content.split('\n');
            const defaultFields = {
                'æ•…äº‹èƒŒæ™¯': 'background',
                'æ–‡é£': 'style',
                'ä¸–ç•Œè§‚&é¢˜æ': 'worldview',
                'ç¯‡å¹…': 'length',
                'ä½“è£': 'genre',
                'å…ƒç´ è¦æ±‚': 'elements'
            };
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line.startsWith('- ')) continue;
                
                const colonIndex = line.indexOf(':');
                if (colonIndex === -1) continue;
                
                const fieldName = line.substring(2, colonIndex).trim();
                let fieldContent = line.substring(colonIndex + 1).trim();
                
                // å¤„ç†å¤šè¡Œå†…å®¹
                let j = i + 1;
                while (j < lines.length && !lines[j].trim().startsWith('- ') && lines[j].trim() !== '') {
                    fieldContent += '\n' + lines[j].trim();
                    if (fieldContent.includes('}}')) break;
                    j++;
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºé»˜è®¤å­—æ®µ
                let isDefaultField = false;
                for (const [key, value] of Object.entries(defaultFields)) {
                    if (fieldName === key) {
                        isDefaultField = true;
                        
                        if (value === 'worldview') {
                            if (fieldContent === 'å‰§åœºå†…å®¹æ ¹æ®ä¸»çº¿å‰§æƒ…å’Œå½“å‰ä¸–ç•Œè§‚åŠ¨æ€é€‚é…ã€‚') {
                                config.worldviewMode = 'consistent';
                            } else {
                                config.worldviewMode = 'custom';
                                config.worldviewCustom = extractRandomContent(fieldContent);
                            }
                        } else if (value === 'elements') {
                            const originalValue = line.substring(colonIndex + 1).trim();
                            config.elementsRepeat = countRandomOccurrences(originalValue);
                            config[value] = extractRandomContent(fieldContent);
                        } else if (value === 'length') { // [GEMINI] BUGFIX: æ·»åŠ å¯¹'length'çš„ç‰¹æ®Šå¤„ç†
                            const numberMatch = fieldContent.match(/\d+/); // æå–æ•°å­—
                            if (numberMatch) {
                                config[value] = numberMatch[0];
                            } else {
                                config[value] = '2000'; // é»˜è®¤å›é€€
                            }
                        } else {
                            config[value] = extractRandomContent(fieldContent);
                        }
                        break;
                    }
                }
                
                // å¦‚æœä¸æ˜¯é»˜è®¤å­—æ®µ,æ·»åŠ ä¸ºè‡ªå®šä¹‰å­—æ®µ
                if (!isDefaultField && fieldName !== 'å°å‰§åœºæ ‡é¢˜éœ€æ ¹æ®å†…å®¹åŠ¨æ€ç”Ÿæˆ' && fieldName !== 'å‰§æƒ…å¿…é¡»å®Œæ•´,ä»å¼€å¤´åˆ°ç»“å°¾,ä¸èƒ½ä»…æ˜¯å‰§æƒ…ç‰‡æ®µ') {
                    config.customFields.push({
                        name: fieldName,
                        type: 'random',
                        content: extractRandomContent(fieldContent),
                        enabled: true,
                        repeat: countRandomOccurrences(fieldContent)
                    });
                }
            }
            
            // åº”ç”¨é…ç½®
            applyConfig(config);
        }

        // æå–{{random:...}}ä¸­çš„å†…å®¹ï¼ˆæ”¯æŒåµŒå¥—{{}}ï¼‰
        function extractRandomContent(text) {
            // æŸ¥æ‰¾ç¬¬ä¸€ä¸ª{{random:
            const randomStart = text.indexOf('{{random:');
            if (randomStart === -1) {
                // å¦‚æœä¸åŒ…å«{{random:ï¼Œä½†å¯èƒ½åŒ…å«{{}}ï¼Œç›´æ¥è¿”å›ï¼ˆæˆ–æ ¹æ®éœ€è¦è¿”å›å‰¥ç¦»äº†{{}}çš„å†…å®¹ï¼‰
                // é‰´äºä¸Šä¸‹æ–‡ï¼Œå¯èƒ½æ˜¯æ²¡æœ‰{{random:}}çš„çº¯æ–‡æœ¬ï¼Œç›´æ¥è¿”å›
                return text;
            }
            
            // æ‰¾åˆ°åŒ¹é…çš„ç»“æŸ}}
            let depth = 2; // {{random: ä¸­å·²æœ‰ä¸¤ä¸ª{
            let i = randomStart + 9;
            
            while (i < text.length && depth > 0) {
                if (text[i] === '{') {
                    depth++;
                } else if (text[i] === '}') {
                    depth--;
                }
                i++;
            }
            
            if (depth === 0) {
                return text.substring(randomStart + 9, i - 2);
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç»“æŸ}}ï¼Œè¯´æ˜æ ¼å¼æœ‰é—®é¢˜ï¼Œä½†è¿˜æ˜¯å°è¯•è¿”å›å¼€å§‹{{random:}}ä¹‹åçš„å†…å®¹
            return text.substring(randomStart + 9);
        }

        // è®¡ç®—{{random:...}}å‡ºç°çš„æ¬¡æ•°ï¼ˆæ”¯æŒåµŒå¥—ï¼‰
        function countRandomOccurrences(text) {
            let count = 0;
            let i = 0;
            
            while (i < text.length) {
                if (i <= text.length - 9 && text.substring(i, i + 9) === '{{random:') {
                    count++;
                    // è·³è¿‡è¿™ä¸ª{{random:...}}çš„å†…å®¹
                    let depth = 2;
                    i += 9;
                    while (i < text.length && depth > 0) {
                        if (text[i] === '{') {
                            depth++;
                        } else if (text[i] === '}') {
                            depth--;
                        }
                        i++;
                    }
                } else {
                    i++;
                }
            }
            
            return count > 0 ? count : 1;
        }
    </script>
</body>
</html>
