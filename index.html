<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WWW小剧场生成助手</title>
    <style>
        /* 全局样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-top: 80px;
        }

        /* 浮动导航栏 */
        .floating-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 15px 20px;
        }

        .nav-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .nav-content button {
            background: white;
            border: 1px solid #cbd5e1;
            color: #475569;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .nav-content button:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* 主容器 */
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        /* 头部区域 */
        .header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 30px;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* 使用说明模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal h2 {
            color: #3b82f6;
            margin-bottom: 15px;
        }

        .modal p {
            line-height: 1.8;
            color: #555;
            margin-bottom: 10px;
        }

        .modal a {
            color: #3b82f6;
            text-decoration: none;
        }

        .modal a:hover {
            text-decoration: underline;
        }

        /* 主体内容 */
        .content {
            padding: 30px;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        /* 字段开关样式 */
        .field-toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #cbd5e1;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .toggle-switch.active {
            background: #3b82f6;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 26px;
        }

        .form-group.disabled {
            opacity: 0.5;
        }

        .form-group.disabled input,
        .form-group.disabled textarea,
        .form-group.disabled select {
            pointer-events: none;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #334155;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .required::after {
            content: '*';
            color: #ef4444;
            margin-left: 4px;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .hint {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }

        /* 单选按钮样式 */
        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }

        .radio-group input[type="radio"],
        .radio-group input[type="checkbox"] {
            margin-right: 8px;
        }

        /* 自定义字段区域 */
        .custom-fields {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e2e8f0;
        }

        .custom-field {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            position: relative;
        }

        .custom-field.disabled {
            opacity: 0.5;
        }

        .custom-field.disabled input,
        .custom-field.disabled textarea,
        .custom-field.disabled select,
        .custom-field.disabled button {
            pointer-events: none;
        }

        .custom-field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .custom-field-actions {
            display: flex;
            gap: 8px;
        }

        .copy-field-btn, .move-up-btn, .move-down-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-field-btn:hover, .move-up-btn:hover, .move-down-btn:hover {
            background: #4f46e5;
        }

        .remove-field-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-field-btn:hover {
            background: #dc2626;
        }

        .add-field-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 15px;
        }

        .add-field-btn:hover {
            background: #059669;
        }

        /* 输出文本块 */
        .output-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e2e8f0;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .output-header h3 {
            color: #334155;
        }

        .output-actions {
            display: flex;
            gap: 10px;
        }

        .copy-btn, .save-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .copy-btn:hover, .save-btn:hover {
            background: #2563eb;
        }

        .save-btn {
            background: #10b981;
        }

        .save-btn:hover {
            background: #059669;
        }

        .output-box {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
        }

        .output-box:empty::before {
            content: '修改表单内容会自动生成...';
            color: #64748b;
        }

        /* 预览区域 */
        .preview-section {
            margin-top: 20px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
        }

        .preview-btn {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .preview-btn:hover {
            background: #7c3aed;
        }

        .preview-box {
            background: #f1f5f9;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            color: #334155;
        }

        .preview-box:empty::before {
            content: '点击"抽一发！"按钮查看抽取结果...';
            color: #94a3b8;
        }

        /* 配置列表模态框 */
        .config-list {
            margin-top: 20px;
        }

        .config-search {
            margin-bottom: 20px;
        }

        .config-search-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .config-search input {
            flex: 1;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
        }

        /* Toggle开关样式 */
        .search-toggle {
            display: flex;
            background: #f1f5f9;
            border-radius: 20px;
            padding: 4px;
            gap: 4px;
        }

        .search-toggle-option {
            padding: 6px 16px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 13px;
            color: #64748b;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .search-toggle-option.active {
            background: #3b82f6;
            color: white;
        }

        .config-sort {
            margin-bottom: 15px;
        }

        .config-sort label {
            font-size: 14px;
            color: #334155;
            margin-right: 10px;
        }

        .config-sort select {
            padding: 6px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 13px;
        }

        .config-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-item:hover {
            background: #f1f5f9;
        }

        .config-name {
            font-weight: 600;
            color: #334155;
            cursor: pointer;
            flex: 1;
            padding: 5px;
            border: 2px solid transparent;
            border-radius: 4px;
        }

        .config-name:hover {
            color: #3b82f6;
        }

        .config-name.editing {
            border-color: #3b82f6;
            background: white;
            cursor: text;
        }

        .config-time {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }

        .config-actions {
            display: flex;
            gap: 8px;
        }

        .config-actions button {
            padding: 5px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 12px;
        }

        .rename-btn {
            background: #3b82f6;
            color: white;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        /* 选项编辑器 */
        .options-editor {
            margin-top: 10px;
        }

        .options-editor.edit-mode .option-item {
            display: flex;
        }

        .options-editor.view-mode .option-item {
            display: none;
        }

        .options-editor.edit-mode .add-option-btn {
            display: inline-block;
        }

        .options-editor.view-mode .add-option-btn {
            display: none;
        }

        .options-display {
            display: none;
        }

        .options-editor.view-mode .options-display {
            display: block;
        }

        .option-item {
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }

        .option-item input {
            flex: 1;
        }

        .option-item button {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-option-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
        }

        .toggle-edit-btn {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }

        .toggle-edit-btn:hover {
            background: #d97706;
        }

        /* 自定义标签输入 */
        .custom-tag-input {
            margin-top: 10px;
            display: none;
        }

        .custom-tag-input input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
        }

        /* 提示消息 */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            display: none;
            animation: slideIn 0.3s;
        }

        .toast.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                padding-top: 100px;
            }

            .floating-nav {
                padding: 10px;
            }

            .nav-content {
                justify-content: center;
                gap: 6px;
            }

            .nav-content button {
                padding: 6px 12px;
                font-size: 12px;
                flex: 1 1 auto;
                min-width: 70px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 22px;
            }

            .content {
                padding: 20px;
            }

            .modal-content {
                padding: 20px;
            }

            .output-actions, .preview-actions {
                flex-direction: column;
            }

            .config-search-row {
                flex-direction: column;
                align-items: stretch;
            }

            .search-toggle {
                justify-content: center;
            }
        }

        /* 隐藏的文件输入 */
        #import-file {
            display: none;
        }

        /* 随机次数输入 */
        .repeat-count {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .repeat-count label {
            margin: 0;
            font-weight: normal;
            font-size: 14px;
        }

        .repeat-count input {
            width: 80px;
        }

        .no-results {
            text-align: center;
            color: #64748b;
            padding: 20px;
            font-size: 14px;
        }

        /* 滚动按钮 */
        .scroll-btn {
            position: fixed;
            right: 20px;
            width: 48px;
            height: 48px;
            background: rgba(59, 130, 246, 0.9);
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .scroll-btn:hover {
            background: rgba(37, 99, 235, 0.9);
            transform: scale(1.1);
        }

        .scroll-btn.show {
            display: flex;
        }

        .scroll-to-top {
            bottom: 90px;
        }

        .scroll-to-bottom {
            bottom: 30px;
        }

        @media (max-width: 768px) {
            .scroll-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .scroll-to-top {
                bottom: 70px;
            }

            .scroll-to-bottom {
                bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- 浮动导航栏 -->
    <div class="floating-nav">
        <div class="nav-content">
            <button onclick="openConfigList()">📋 配置列表</button>
            <button onclick="exportConfig('json')">📤 导出JSON</button>
            <button onclick="exportConfig('txt')">📤 导出TXT</button>
            <button onclick="document.getElementById('import-file').click()">📥 导入配置</button>
            <button onclick="openHelp()">使用说明</button>
            <input type="file" id="import-file" accept=".json,.txt" onchange="importConfig(event)">
        </div>
    </div>

    <!-- 主容器 -->
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1>小剧场生成助手</h1>
            <p>——作者:WWW</p>
        </div>

        <!-- 主体内容 -->
        <div class="content">
            <form id="main-form">
                <!-- 1. 标题 -->
                <div class="form-group" data-field="title">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label class="required">小剧场标题</label>
                    </div>
                    <input type="text" id="title" value="番外" required oninput="autoGenerate()">
                </div>

                <!-- 2. 使用模式 -->
                <div class="form-group" data-field="mode">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label class="required">使用模式</label>
                    </div>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="mode" value="independent" checked onchange="toggleModeOptions(); autoGenerate();">
                            独立使用
                        </label>
                        <label>
                            <input type="radio" name="mode" value="worldbook" onchange="toggleModeOptions(); autoGenerate();">
                            WWW小剧场
                        </label>
                        <label>
                            <input type="radio" name="mode" value="puppy" onchange="toggleModeOptions(); autoGenerate();">
                            小狗之神小剧场
                        </label>
                        <label>
                            <input type="radio" name="mode" value="custom" onchange="toggleModeOptions(); autoGenerate();">
                            作为其他世界书条目
                        </label>
                    </div>
                    <div class="custom-tag-input" id="custom-tag-input">
                        <label>自定义标签名称</label>
                        <input type="text" id="custom-tag" placeholder="例如: my-tag" value="little-play" oninput="autoGenerate()">
                        <div class="hint">标签格式将为: &lt;标签名称&gt;...&lt;/标签名称&gt;</div>
                    </div>
                </div>

                <!-- 3. 生成要求 -->
                <div class="form-group" data-field="requirements">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label class="required">生成要求</label>
                    </div>
                    <textarea id="requirements" required oninput="autoGenerate()">- 故事中的角色更换至其他世界观,生成一段完整的小故事,以主要角色间的对话和互动为核心,展现角色之间的情感关系,内容足够新颖吸引人。
- 角色自动适配为该世界观下合适的身份,不得更改为该世界观下已存在的角色。例如,如果世界观是圣杯战争,不得将{{user}}设定为卫宫切嗣,而是要设定为该世界观下名为{{user}}的新角色。
- 可根据需要补充背景板NPC参与剧情,但不能着墨太多,只能作为主要角色的衬托。</textarea>
                </div>

                <!-- 4. 故事背景 -->
                <div class="form-group" data-field="background">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label>故事背景</label>
                    </div>
                    <textarea id="background" oninput="autoGenerate()">自由发挥,
角色们均为这个世界的原住民,
角色们均为刚刚穿越来到这个世界的,
角色们均为穿越来到这个世界的，已经穿越很久了,
{{user}}带着快穿系统穿越到这个世界，而{{char}}是这个世界的原住民，{{user}}的任务是攻略{{char}},
{{char}}带着快穿系统穿越到这个世界，而{{user}}是这个世界的原住民，{{char}}的任务是攻略{{user}},
角色们带着快穿系统穿越到这个世界，有着一个特定的任务要完成,
角色们被迫穿越到这个世界，要完成一个特定的任务才能回到原世界,
角色们带着前世（主线）的记忆投胎到这个世界,
角色们投胎到这个世界，但是丢失了前世（主线）的记忆,
角色们带着前世（主线）的记忆在这个世界轮回,
角色们所在的这个世界实际上是虚拟世界，TA们不知道自己身在虚拟世界中，而上位世界有一些观众在围观他们的生活直播,
角色们所在的这个世界实际上是虚拟世界，TA们知道自己身在虚拟世界中，而上位世界有一些观众在围观他们的生活直播，TA们需要满足观众的一些要求,
{{char}}是{{user}}前世（主线剧情）的恋人，但是{{user}}已经忘了{{char}},
{{user}}是{{char}}前世（主线剧情）的恋人，但是{{char}}已经忘了{{user}},
{{char}}和{{user}}是前世（主线剧情）的恋人，但是TA们已经忘了彼此,
{{char}}被困在了这个世界里，而{{user}}是来救TA出去的,
{{user}}被困在了这个世界里，而{{char}}是来救TA出去的</textarea>
                    <div class="hint">当需要在多个背景中随机选择一个时,请用英文逗号分隔。</div>
                </div>

                <!-- 5. 文风要求 -->
                <div class="form-group" data-field="style">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label>文风要求</label>
                    </div>
                    <textarea id="style" oninput="autoGenerate()">正剧,
史诗感,
轻松诙谐吐槽,
搞笑撕逼,
虐向,
纯爱煽情,
NSFW</textarea>
                    <div class="hint">当需要在多个文风中随机选择一个时,请用英文逗号分隔。</div>
                </div>

                <!-- 6. 世界观&题材要求 -->
                <div class="form-group" data-field="worldview">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label class="required">世界观&题材要求</label>
                    </div>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="worldview" value="consistent" onchange="toggleWorldviewInput(); autoGenerate();">
                            和主线一致
                        </label>
                        <label>
                            <input type="radio" name="worldview" value="custom" checked onchange="toggleWorldviewInput(); autoGenerate();">
                            自定义
                        </label>
                    </div>
                    <textarea id="worldview-custom" style="margin-top: 10px;" oninput="autoGenerate()">自由指定一个AU,自由指定一个游戏AU,自由指定一个现实作品的AU,
虫族（社会结构包含虫母、雄虫、亚雌，虫母为尊）,虫族（社会结构包含雄虫、雌虫、亚雌，雄虫为尊，雌虫大部分为军雌）,哨兵向导,ABO,dom/sub,兽人,
龙傲天文学,狗血小言文,恋爱少女漫,热血少年漫,晋江文学,海棠文学,
克苏鲁,血族,圣杯战争,魔法少女小圆,EVA,霍格沃兹,超级英雄,盗墓笔记,黑塔利亚,JOJO的奇妙冒险（可以作为替身使者或替身）,西游记,
赛博朋克2077,底特律变人,阴阳师手游,剑网三,
西幻,DND,
蒸汽朋克,赛博朋克,恐怖怪谈,规则怪谈,星际,星际机甲,星球大战,无限恐怖,无限流,
近未来,科幻,末世废土,后启示录,末日将至,末世种田,末世异能,
架空历史,中国古代,春秋战国,秦朝,三国,唐朝,宋朝,明朝,清朝,民国,革命年代,知青下乡,
日本平安时代,日本江户时代,日本大正时代,
欧洲中世纪,欧洲文艺复兴时期,欧洲近代,
一战,二战,战争年代,第三次世界大战,
武侠,武侠（金庸作品）,中式玄幻,仙侠修真,中式妖神,
架空神话,希腊神话,希伯来神话,印度神话,埃及神话,中国洪荒神话,中国神话,日本妖神,
工地情缘(TA们是工友),青春校园,娱乐圈（综艺/团综出道/演员）,小妈文学,黑帮,警匪（猫鼠游戏）,推理破案</textarea>
                    <div class="hint">当需要在多个世界观&题材中随机选择一个时,请用英文逗号分隔。</div>
                </div>

                <!-- 7. 篇幅要求 -->
                <div class="form-group" data-field="length">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label class="required">篇幅要求</label>
                    </div>
                    <input type="number" id="length" value="3000" min="1" required oninput="autoGenerate()">
                </div>

                <!-- 8. 体裁要求 -->
                <div class="form-group" data-field="genre">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label>体裁要求</label>
                    </div>
                    <textarea id="genre" oninput="autoGenerate()">自由发挥,诗歌,戏剧,电影分镜,小说,视觉小说,论文,研究报告,散文,杂文,日记,回忆录,人物档案,论坛帖子,个人主页,语录,箴言,摘抄,新闻报道,简报,公告,日志,笔记,归档记录,朋友圈,回忆相册</textarea>
                    <div class="hint">当需要在多个体裁中随机选择一个时,请用英文逗号分隔。</div>
                </div>

                <!-- 9. 元素要求 -->
                <div class="form-group" data-field="elements">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <label>元素要求</label>
                    </div>
                    <textarea id="elements" oninput="autoGenerate()">自由发挥，越狗血越恶俗越好,里番经典剧情,霸总文学经典剧情,言情经典剧情,玛丽苏文学经典剧情,龙傲天文学经典剧情,迪化流经典剧情,小妈文学,先婚后爱,婚礼当天抢婚,赛博忏悔室,社死现场,宫廷权谋,囚禁play,网恋奔现,私奔</textarea>
                    <div class="hint">当需要在多个元素中随机选择一个时,请用英文逗号分隔。“抽取次数”用于指定需要选择的随机元素个数。例如，如果把“抽取次数”设置成3，则会在元素列表里进行三次抽取。</div>
                    <div class="repeat-count">
                        <label>抽取次数:</label>
                        <input type="number" id="elements-repeat" value="1" min="1" max="99" oninput="autoGenerate()">
                    </div>
                </div>

                <!-- 自定义字段区域 -->
                <div class="custom-fields">
                    <h3 style="margin-bottom: 20px; color: #334155;">自定义字段</h3>
                    <div id="custom-fields-container"></div>
                    <button type="button" class="add-field-btn" onclick="addCustomField()">➕ 添加自定义字段</button>
                </div>
            </form>

            <!-- 输出文本块 -->
            <div class="output-section">
                <div class="output-header">
                    <h3>生成结果</h3>
                    <div class="output-actions">
                        <button class="copy-btn" onclick="copyOutput()">📋 复制</button>
                        <button class="save-btn" onclick="saveCurrentConfig()">💾 保存配置</button>
                    </div>
                </div>
                <div class="output-box" id="output"></div>
                
                <!-- 预览区域 -->
                <div class="preview-section">
                    <div class="preview-header">
                        <h4 style="color: #334155;">随机结果预览</h4>
                        <div class="preview-actions">
                            <button class="copy-btn" onclick="copyPreview()">📋 复制</button>
                            <button class="preview-btn" onclick="generatePreview()">🎲 抽一发！</button>
                        </div>
                    </div>
                    <div class="preview-box" id="preview"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 使用说明模态框 -->
    <div class="modal" id="help-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeHelp()">✕</button>
            <h2>使用说明</h2>
            <p>本工具可以生成格式化的小剧场,并可通过酒馆提供的宏{{random:...}}来进行随机选项选择，提升生成多样性。还支持添加自定义字段，填写你想要实现的要求。在发送到酒馆聊天里时，{{random:...}}内的选项只会有一个被随机选择显示出来，不会都发送给AI。</p>
            <p>点击上方“保存配置”按钮可以保存配置。点击“导入/导出配置”可以将配置文件以JSON格式导入/导出，方便分享。</p>
            <p>更新链接: <a href="https://discord.com/channels/1291925535324110879/1421177491959316570/1421177491959316570" target="_blank">Discord更新链接</a>。同时我也在写一系列小剧场和小工具，欢迎体验和repo~~有好饭能让我也吃一吃吗🥹</p>
        </div>
    </div>

    <!-- 配置列表模态框 -->
    <div class="modal" id="config-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeConfigList()">✕</button>
            <h2>配置列表</h2>
            
            <div class="config-search">
                <div class="config-search-row">
                    <input type="text" id="search-input" placeholder="搜索配置名称(支持空格分隔多个关键词)..." oninput="filterConfigs()">
                    <div class="search-toggle">
                        <div class="search-toggle-option active" data-mode="fuzzy" onclick="toggleSearchMode(this)">模糊</div>
                        <div class="search-toggle-option" data-mode="exact" onclick="toggleSearchMode(this)">精确</div>
                    </div>
                </div>
            </div>

            <div class="config-sort">
                <label>排序:</label>
                <select id="sort-select" onchange="sortConfigs()">
                    <option value="time-desc">时间倒序</option>
                    <option value="time-asc">时间顺序</option>
                    <option value="name-asc">名称 A-Z</option>
                    <option value="name-desc">名称 Z-A</option>
                </select>
            </div>
            
            <div class="config-list" id="config-list"></div>
        </div>
    </div>

    <!-- 提示消息 -->
    <div class="toast" id="toast"></div>

    <!-- 滚动按钮 -->
    <button class="scroll-btn scroll-to-top" id="scroll-to-top" onclick="scrollToTop()">↑</button>
    <button class="scroll-btn scroll-to-bottom" id="scroll-to-bottom" onclick="scrollToBottom()">↓</button>

    <script>
        // 自定义字段计数器
        let customFieldCounter = 0;
        
        // 存储的配置列表
        let savedConfigs = [];

        // 当前搜索词和排序方式
        let currentSearchTerm = '';
        let currentSortMode = 'time-desc';
        let previousSortMode = 'time-desc';

        // 页面加载时初始化
        window.onload = function() {
            loadSavedConfigs();
            toggleModeOptions();
            setTimeout(() => {
                autoGenerate();
            }, 100);
            
            // 监听滚动事件
            window.addEventListener('scroll', handleScroll);
        };

        // 处理滚动显示/隐藏按钮
        function handleScroll() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollHeight = document.documentElement.scrollHeight;
            const clientHeight = document.documentElement.clientHeight;
            
            const scrollToTopBtn = document.getElementById('scroll-to-top');
            const scrollToBottomBtn = document.getElementById('scroll-to-bottom');
            
            // 滚动超过300px显示回顶按钮
            if (scrollTop > 300) {
                scrollToTopBtn.classList.add('show');
            } else {
                scrollToTopBtn.classList.remove('show');
            }
            
            // 距离底部超过300px显示回底按钮
            if (scrollHeight - scrollTop - clientHeight > 300) {
                scrollToBottomBtn.classList.add('show');
            } else {
                scrollToBottomBtn.classList.remove('show');
            }
        }

        // 滚动到顶部
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // 滚动到底部
        function scrollToBottom() {
            window.scrollTo({
                top: document.documentElement.scrollHeight,
                behavior: 'smooth'
            });
        }

        // 加载已保存的配置列表
        function loadSavedConfigs() {
            try {
                const saved = localStorage.getItem('theaterConfigList');
                if (saved) {
                    savedConfigs = JSON.parse(saved);
                }
            } catch (e) {
                console.error('加载配置列表失败', e);
                savedConfigs = [];
            }
        }

        // 保存配置列表到本地存储
        function saveSavedConfigs() {
            try {
                localStorage.setItem('theaterConfigList', JSON.stringify(savedConfigs));
            } catch (e) {
                console.error('保存配置列表失败', e);
            }
        }

        // 打开使用说明
        function openHelp() {
            document.getElementById('help-modal').classList.add('active');
        }

        // 关闭使用说明
        function closeHelp() {
            document.getElementById('help-modal').classList.remove('active');
        }

        // 点击模态框外部关闭
        document.getElementById('help-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeHelp();
            }
        });

        document.getElementById('config-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeConfigList();
            }
        });

        // 切换字段开关
        function toggleField(toggleElement) {
            toggleElement.classList.toggle('active');
            const formGroup = toggleElement.closest('.form-group, .custom-field');
            if (toggleElement.classList.contains('active')) {
                formGroup.classList.remove('disabled');
            } else {
                formGroup.classList.add('disabled');
            }
            autoGenerate();
        }

        // 切换使用模式选项
        function toggleModeOptions() {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const customTagInput = document.getElementById('custom-tag-input');
            
            if (mode === 'custom') {
                customTagInput.style.display = 'block';
            } else {
                customTagInput.style.display = 'none';
            }
        }

        // 切换世界观输入框
        function toggleWorldviewInput() {
            const customRadio = document.querySelector('input[name="worldview"][value="custom"]');
            const customTextarea = document.getElementById('worldview-custom');
            customTextarea.disabled = !customRadio.checked;
            customTextarea.style.display = customRadio.checked ? 'block' : 'none';
        }

        // 添加自定义字段
        function addCustomField() {
            customFieldCounter++;
            const container = document.getElementById('custom-fields-container');
            const fieldId = 'custom-field-' + customFieldCounter;
            
            const fieldHtml = `
                <div class="custom-field" id="${fieldId}" data-field-id="${customFieldCounter}">
                    <div class="field-toggle-wrapper">
                        <div class="toggle-switch active" onclick="toggleField(this)"></div>
                        <div class="custom-field-header" style="flex: 1; margin: 0;">
                            <h4>#${customFieldCounter}</h4>
                            <div class="custom-field-actions">
                                <button type="button" class="copy-field-btn" onclick="copyCustomField('${fieldId}')">📋</button>
                                <button type="button" class="move-up-btn" onclick="moveFieldUp('${fieldId}')">↑</button>
                                <button type="button" class="move-down-btn" onclick="moveFieldDown('${fieldId}')">↓</button>
                                <button type="button" class="remove-field-btn" onclick="removeCustomField('${fieldId}')">删除</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>字段名称</label>
                        <input type="text" class="field-name" placeholder="例如:角色关系" oninput="autoGenerate()">
                    </div>
                    <div class="form-group">
                        <label>字段类型</label>
                        <select class="field-type" onchange="updateFieldInput(this, '${fieldId}')">
                            <option value="text">文本框</option>
                            <option value="radio">单选</option>
                            <option value="checkbox">多选</option>
                            <option value="random">随机抽取</option>
                        </select>
                    </div>
                    <div class="form-group field-input-container">
                        <label>字段内容</label>
                        <textarea class="field-content" placeholder="请输入内容" oninput="autoGenerate()"></textarea>
                        <div class="hint">当需要在多个选项中随机选择一个时,请选择随机字段，并用英文逗号分隔不同选项。</div>
                    </div>
                    <div class="options-editor edit-mode" style="display: none;" data-mode="edit">
                        <label>配置选项</label>
                        <div class="options-list"></div>
                        <button type="button" class="add-option-btn" onclick="addOption('${fieldId}')">+ 添加选项</button>
                        <div class="options-display"></div>
                        <button type="button" class="toggle-edit-btn" onclick="toggleEditMode('${fieldId}')">应用</button>
                    </div>
                    <div class="repeat-count" style="display: none;">
                        <label>随机次数:</label>
                        <input type="number" class="field-repeat" value="1" min="1" max="99" oninput="autoGenerate()">
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', fieldHtml);
            autoGenerate();
        }

        // 复制自定义字段
        function copyCustomField(fieldId) {
            const sourceField = document.getElementById(fieldId);
            const fieldData = extractFieldData(sourceField);
            
            // 创建新字段
            addCustomField();
            const newFieldId = 'custom-field-' + customFieldCounter;
            const newField = document.getElementById(newFieldId);
            
            // 应用数据
            applyFieldData(newField, fieldData, newFieldId);
            
            showToast('字段复制成功!');
        }

        // 提取字段数据
        function extractFieldData(field) {
            const toggle = field.querySelector('.toggle-switch');
            const fieldType = field.querySelector('.field-type').value;
            const data = {
                name: field.querySelector('.field-name').value,
                type: fieldType,
                enabled: toggle.classList.contains('active'),
                repeat: field.querySelector('.field-repeat').value
            };
            
            if (fieldType === 'text' || fieldType === 'random') {
                data.content = field.querySelector('.field-content').value;
            } else if (fieldType === 'radio' || fieldType === 'checkbox') {
                data.options = [];
                field.querySelectorAll('.option-item input').forEach(input => {
                    if (input.value.trim()) {
                        data.options.push(input.value.trim());
                    }
                });
                const optionsEditor = field.querySelector('.options-editor');
                data.editMode = optionsEditor.getAttribute('data-mode') === 'edit';
            }
            
            return data;
        }

        // 应用字段数据
        function applyFieldData(field, data, fieldId) {
            field.querySelector('.field-name').value = data.name;
            field.querySelector('.field-type').value = data.type;
            field.querySelector('.field-repeat').value = data.repeat;
            
            const toggle = field.querySelector('.toggle-switch');
            if (data.enabled) {
                toggle.classList.add('active');
                field.classList.remove('disabled');
            } else {
                toggle.classList.remove('active');
                field.classList.add('disabled');
            }
            
            updateFieldInput(field.querySelector('.field-type'), fieldId);
            
            if (data.type === 'text' || data.type === 'random') {
                field.querySelector('.field-content').value = data.content || '';
            } else if ((data.type === 'radio' || data.type === 'checkbox') && data.options) {
                const optionsList = field.querySelector('.options-list');
                optionsList.innerHTML = '';
                data.options.forEach(opt => {
                    addOptionItem(optionsList, opt, fieldId);
                });
                
                const optionsEditor = field.querySelector('.options-editor');
                if (data.editMode === false) {
                    toggleEditMode(fieldId);
                }
            }
        }

        // 删除自定义字段
        function removeCustomField(fieldId) {
            document.getElementById(fieldId).remove();
            autoGenerate();
        }

        // 上移字段
        function moveFieldUp(fieldId) {
            const field = document.getElementById(fieldId);
            const prev = field.previousElementSibling;
            if (prev) {
                field.parentNode.insertBefore(field, prev);
                autoGenerate();
            }
        }

        // 下移字段
        function moveFieldDown(fieldId) {
            const field = document.getElementById(fieldId);
            const next = field.nextElementSibling;
            if (next) {
                field.parentNode.insertBefore(next, field);
                autoGenerate();
            }
        }

        // 更新字段输入方式
        function updateFieldInput(select, fieldId) {
            const field = document.getElementById(fieldId);
            const repeatCountDiv = field.querySelector('.repeat-count');
            const contentContainer = field.querySelector('.field-input-container');
            const optionsEditor = field.querySelector('.options-editor');
            const fieldType = select.value;
            
            // 隐藏所有
            repeatCountDiv.style.display = 'none';
            contentContainer.style.display = 'none';
            optionsEditor.style.display = 'none';
            
            if (fieldType === 'random') {
                contentContainer.style.display = 'block';
                repeatCountDiv.style.display = 'flex';
            } else if (fieldType === 'text') {
                contentContainer.style.display = 'block';
            } else if (fieldType === 'radio' || fieldType === 'checkbox') {
                optionsEditor.style.display = 'block';
                
                // 保持之前的模式
                const currentMode = optionsEditor.getAttribute('data-mode');
                if (!currentMode || currentMode === 'edit') {
                    optionsEditor.classList.remove('view-mode');
                    optionsEditor.classList.add('edit-mode');
                    optionsEditor.setAttribute('data-mode', 'edit');
                } else {
                    optionsEditor.classList.remove('edit-mode');
                    optionsEditor.classList.add('view-mode');
                }
                
                renderOptionsEditor(fieldId, fieldType);
            }
            
            autoGenerate();
        }

        // 渲染选项编辑器
        function renderOptionsEditor(fieldId, fieldType) {
            const field = document.getElementById(fieldId);
            const optionsEditor = field.querySelector('.options-editor');
            const optionsList = optionsEditor.querySelector('.options-list');
            
            // 获取现有选项或创建默认选项
            let options = [];
            const existingOptions = optionsList.querySelectorAll('.option-item input');
            if (existingOptions.length > 0) {
                existingOptions.forEach(input => {
                    if (input.value.trim()) {
                        options.push(input.value.trim());
                    }
                });
            }
            
            if (options.length === 0) {
                options = ['选项1', '选项2'];
            }
            
            optionsList.innerHTML = '';
            options.forEach((opt, index) => {
                addOptionItem(optionsList, opt, fieldId);
            });
        }

        // 添加选项项
        function addOptionItem(container, value = '', fieldId) {
            const optionHtml = `
                <div class="option-item">
                    <input type="text" value="${value}" placeholder="选项内容" oninput="autoGenerate()">
                    <button type="button" onclick="removeOption(this, '${fieldId}')">删除</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', optionHtml);
        }

        // 添加选项
        function addOption(fieldId) {
            const field = document.getElementById(fieldId);
            const optionsList = field.querySelector('.options-list');
            addOptionItem(optionsList, '', fieldId);
            autoGenerate();
        }

        // 删除选项
        function removeOption(btn, fieldId) {
            const field = document.getElementById(fieldId);
            const optionsList = field.querySelector('.options-list');
            if (optionsList.children.length > 1) {
                btn.closest('.option-item').remove();
                autoGenerate();
            } else {
                showToast('至少需要保留一个选项', 'error');
            }
        }

        // 切换编辑模式
        function toggleEditMode(fieldId) {
            const field = document.getElementById(fieldId);
            const optionsEditor = field.querySelector('.options-editor');
            const toggleBtn = optionsEditor.querySelector('.toggle-edit-btn');
            const optionsDisplay = optionsEditor.querySelector('.options-display');
            const fieldType = field.querySelector('.field-type').value;
            
            if (optionsEditor.classList.contains('edit-mode')) {
                // 切换到查看模式
                optionsEditor.classList.remove('edit-mode');
                optionsEditor.classList.add('view-mode');
                optionsEditor.setAttribute('data-mode', 'view');
                toggleBtn.textContent = '编辑';
                
                // 显示选项
                const options = [];
                field.querySelectorAll('.option-item input').forEach(input => {
                    if (input.value.trim()) {
                        options.push(input.value.trim());
                    }
                });
                
                if (fieldType === 'radio') {
                    optionsDisplay.innerHTML = '<div class="radio-group">' + 
                        options.map((opt, idx) => `
                            <label>
                                <input type="radio" name="${fieldId}-display" ${idx === 0 ? 'checked' : ''} onchange="autoGenerate()">
                                ${opt}
                            </label>
                        `).join('') + '</div>';
                } else {
                    optionsDisplay.innerHTML = '<div class="radio-group">' + 
                        options.map(opt => `
                            <label>
                                <input type="checkbox" onchange="autoGenerate()">
                                ${opt}
                            </label>
                        `).join('') + '</div>';
                }
            } else {
                // 切换到编辑模式
                optionsEditor.classList.remove('view-mode');
                optionsEditor.classList.add('edit-mode');
                optionsEditor.setAttribute('data-mode', 'edit');
                toggleBtn.textContent = '应用';
            }
            
            autoGenerate();
        }

        // 自动生成输出内容
        function autoGenerate() {
            let output = '';
            
            // 获取表单值
            const titleField = document.querySelector('[data-field="title"]');
            const titleEnabled = !titleField.classList.contains('disabled');
            const title = document.getElementById('title').value.trim();
            
            const modeField = document.querySelector('[data-field="mode"]');
            const modeEnabled = !modeField.classList.contains('disabled');
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const customTag = document.getElementById('custom-tag').value.trim() || 'little-play';
            
            const requirementsField = document.querySelector('[data-field="requirements"]');
            const requirementsEnabled = !requirementsField.classList.contains('disabled');
            const requirements = document.getElementById('requirements').value.trim();
            
            const backgroundField = document.querySelector('[data-field="background"]');
            const backgroundEnabled = !backgroundField.classList.contains('disabled');
            const background = document.getElementById('background').value.trim();
            
            const styleField = document.querySelector('[data-field="style"]');
            const styleEnabled = !styleField.classList.contains('disabled');
            const style = document.getElementById('style').value.trim();
            
            const worldviewField = document.querySelector('[data-field="worldview"]');
            const worldviewEnabled = !worldviewField.classList.contains('disabled');
            const worldviewMode = document.querySelector('input[name="worldview"]:checked').value;
            const worldviewCustom = document.getElementById('worldview-custom').value.trim();
            
            const lengthField = document.querySelector('[data-field="length"]');
            const lengthEnabled = !lengthField.classList.contains('disabled');
            const length = document.getElementById('length').value;
            
            const genreField = document.querySelector('[data-field="genre"]');
            const genreEnabled = !genreField.classList.contains('disabled');
            const genre = document.getElementById('genre').value.trim();
            
            const elementsField = document.querySelector('[data-field="elements"]');
            const elementsEnabled = !elementsField.classList.contains('disabled');
            const elements = document.getElementById('elements').value.trim();
            const elementsRepeat = parseInt(document.getElementById('elements-repeat').value);

            // 根据使用模式添加开始标签
            if (modeEnabled) {
                if (mode === 'worldbook') {
                    output += '<little-play>\n';
                } else if (mode === 'puppy') {
                    output += '<small_theater>\n';
                } else if (mode === 'custom') {
                    output += `<${customTag}>\n`;
                }
            }

            // 标题
            if (titleEnabled && title) {
                output += `【小剧场·${title}】\n整体要求:\n`;
            }

            // 使用模式
            if (modeEnabled && mode === 'independent') {
                output += '- 本次回复需暂停一切正文输出,立刻输出本剧场内容。\n';
            }

            // 生成要求
            if (requirementsEnabled && requirements) {
                output += requirements + '\n';
            }

            // 固定要求
            output += '- 小剧场标题需根据内容动态生成。\n';
            output += '- 剧情必须完整,从开头到结尾,不能仅是剧情片段。\n';

            // 故事背景
            if (backgroundEnabled && background) {
                output += `- 故事背景: {{random:${background}}}\n`;
            }

            // 文风要求
            if (styleEnabled && style) {
                output += `- 文风: {{random:${style}}}\n`;
            }

            // 世界观&题材
            if (worldviewEnabled) {
                if (worldviewMode === 'consistent') {
                    output += '- 剧场内容根据主线剧情和当前世界观动态适配。\n';
                } else if (worldviewCustom) {
                    output += `- 世界观&题材: {{random:${worldviewCustom}}}\n`;
                }
            }

            // 篇幅要求
            if (lengthEnabled && length) {
                output += `- 篇幅: ≥${length}字\n`;
            }

            // 体裁要求
            if (genreEnabled && genre) {
                output += `- 体裁: {{random:${genre}}}\n`;
            }

            // 元素要求
            if (elementsEnabled && elements) {
                output += '- 元素要求: ';
                const elementParts = [];
                for (let i = 0; i < elementsRepeat; i++) {
                    elementParts.push(`{{random:${elements}}}`);
                }
                output += elementParts.join(';') + '\n';
            }

            // 自定义字段
            const customFields = document.querySelectorAll('.custom-field');
            customFields.forEach(field => {
                const toggle = field.querySelector('.toggle-switch');
                const isEnabled = toggle.classList.contains('active');
                
                if (!isEnabled) return;
                
                const name = field.querySelector('.field-name').value.trim();
                const type = field.querySelector('.field-type').value;
                
                if (!name) return;
                
                if (type === 'text') {
                    const content = field.querySelector('.field-content').value.trim();
                    if (content) {
                        output += `- ${name}: ${content}\n`;
                    }
                } else if (type === 'random') {
                    const content = field.querySelector('.field-content').value.trim();
                    const repeat = parseInt(field.querySelector('.field-repeat').value);
                    if (content) {
                        output += `- ${name}: `;
                        const parts = [];
                        for (let i = 0; i < repeat; i++) {
                            parts.push(`{{random:${content}}}`);
                        }
                        output += parts.join(';') + '\n';
                    }
                } else if (type === 'radio') {
                    const optionsEditor = field.querySelector('.options-editor');
                    if (optionsEditor.classList.contains('view-mode')) {
                        const selectedRadio = field.querySelector('input[type="radio"]:checked');
                        if (selectedRadio) {
                            const selectedText = selectedRadio.parentElement.textContent.trim();
                            output += `- ${name}: ${selectedText}\n`;
                        }
                    } else {
                        const options = [];
                        field.querySelectorAll('.option-item input').forEach(input => {
                            if (input.value.trim()) {
                                options.push(input.value.trim());
                            }
                        });
                        if (options.length > 0) {
                            output += `- ${name}: {{random:${options.join(',')}}}\n`;
                        }
                    }
                } else if (type === 'checkbox') {
                    const optionsEditor = field.querySelector('.options-editor');
                    if (optionsEditor.classList.contains('view-mode')) {
                        const selected = [];
                        field.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                            selected.push(checkbox.parentElement.textContent.trim());
                        });
                        if (selected.length > 0) {
                            output += `- ${name}: ${selected.join(',')}\n`;
                        }
                    } else {
                        const options = [];
                        field.querySelectorAll('.option-item input').forEach(input => {
                            if (input.value.trim()) {
                                options.push(input.value.trim());
                            }
                        });
                        if (options.length > 0) {
                            output += `- ${name}: ${options.join(',')}\n`;
                        }
                    }
                }
            });

            // 根据使用模式添加结束标签
            if (modeEnabled) {
                if (mode === 'worldbook') {
                    output += '</little-play>';
                } else if (mode === 'puppy') {
                    output += '</small_theater>';
                } else if (mode === 'custom') {
                    output += `</${customTag}>`;
                }
            }

            // 显示输出
            document.getElementById('output').textContent = output;
        }

        // 生成随机预览
        function generatePreview() {
            const output = document.getElementById('output').textContent;
            if (!output) {
                showToast('请先生成内容', 'error');
                return;
            }
            
            // 解析并替换所有{{random:...}}
            let preview = parseRandomSyntax(output);
            
            document.getElementById('preview').textContent = preview;
        }

        // 解析{{random:...}}语法（支持嵌套{{}}和换行）
        function parseRandomSyntax(text) {
            let result = text;
            let maxIterations = 100; // 防止无限循环
            let iteration = 0;
            
            while (iteration < maxIterations) {
                let changed = false;
                let newResult = '';
                let i = 0;
                
                while (i < result.length) {
                    // 查找{{random:
                    if (i <= result.length - 9 && result.substring(i, i + 9) === '{{random:') {
                        // 找到匹配的结束}}
                        let depth = 2; // 已经有两个{
                        let start = i + 9;
                        let j = start;
                        
                        while (j < result.length && depth > 0) {
                            if (result[j] === '{') {
                                depth++;
                            } else if (result[j] === '}') {
                                depth--;
                            }
                            j++;
                        }
                        
                        if (depth === 0) {
                            // 找到了匹配的}}
                            const content = result.substring(start, j - 2);
                            
                            // 按逗号分隔选项（需要考虑嵌套的{{}}和换行）
                            const options = smartSplit(content, ',');
                            
                            if (options.length > 0) {
                                // 随机选择一个
                                const randomIndex = Math.floor(Math.random() * options.length);
                                newResult += options[randomIndex];
                                changed = true;
                            } else {
                                newResult += result.substring(i, j);
                            }
                            i = j;
                        } else {
                            // 没有找到匹配的结束，保持原样
                            newResult += result[i];
                            i++;
                        }
                    } else {
                        newResult += result[i];
                        i++;
                    }
                }
                
                result = newResult;
                if (!changed) break;
                iteration++;
            }
            
            return result;
        }

        // 智能分割字符串（考虑{{}}嵌套和换行）
        function smartSplit(text, delimiter) {
            const result = [];
            let current = '';
            let depth = 0;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                
                if (char === '{') {
                    depth++;
                    current += char;
                } else if (char === '}') {
                    depth--;
                    current += char;
                } else if (char === delimiter && depth === 0) {
                    // 找到分隔符，保存当前项
                    const trimmed = current.trim();
                    if (trimmed) {
                        result.push(trimmed);
                    }
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // 添加最后一项
            const trimmed = current.trim();
            if (trimmed) {
                result.push(trimmed);
            }
            
            return result.length > 0 ? result : [text.trim()];
        }

        // 复制输出内容
        function copyOutput() {
            const output = document.getElementById('output').textContent;
            if (!output) {
                showToast('没有内容可复制', 'error');
                return;
            }

            navigator.clipboard.writeText(output).then(() => {
                showToast('复制成功!');
            }).catch(() => {
                showToast('复制失败,请手动复制', 'error');
            });
        }

        // 复制预览内容
        function copyPreview() {
            const preview = document.getElementById('preview').textContent;
            if (!preview) {
                showToast('没有预览内容可复制', 'error');
                return;
            }

            navigator.clipboard.writeText(preview).then(() => {
                showToast('预览内容复制成功!');
            }).catch(() => {
                showToast('复制失败,请手动复制', 'error');
            });
        }

        // 显示提示消息
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = type === 'success' ? '#10b981' : '#ef4444';
            toast.classList.add('active');
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }

        // 保存当前配置
        function saveCurrentConfig() {
            const title = document.getElementById('title').value.trim() || '未命名';
            const now = new Date();
            const timeStr = now.getFullYear() + 
                            String(now.getMonth() + 1).padStart(2, '0') + 
                            String(now.getDate()).padStart(2, '0') + '_' +
                            String(now.getHours()).padStart(2, '0') + 
                            String(now.getMinutes()).padStart(2, '0') + 
                            String(now.getSeconds()).padStart(2, '0');
            
            const configName = `${title}_${timeStr}`;
            
            const config = collectConfig();
            config.name = configName;
            config.timestamp = now.getTime();
            config.id = now.getTime().toString();
            
            // 检查是否超过99个
            if (savedConfigs.length >= 99) {
                showToast('配置数量已达上限(99个)', 'error');
                return;
            }
            
            savedConfigs.unshift(config);
            saveSavedConfigs();
            showToast('配置保存成功!');
        }

        // 打开配置列表
        function openConfigList() {
            currentSearchTerm = '';
            document.getElementById('search-input').value = '';
            document.getElementById('sort-select').value = previousSortMode;
            currentSortMode = previousSortMode;
            renderConfigList();
            document.getElementById('config-modal').classList.add('active');
        }

        // 关闭配置列表
        function closeConfigList() {
            document.getElementById('config-modal').classList.remove('active');
        }

        // 切换搜索模式
        function toggleSearchMode(element) {
            document.querySelectorAll('.search-toggle-option').forEach(opt => {
                opt.classList.remove('active');
            });
            element.classList.add('active');
            filterConfigs();
        }

        // 过滤配置
        function filterConfigs() {
            const searchTerm = document.getElementById('search-input').value.trim();
            const searchMode = document.querySelector('.search-toggle-option.active').getAttribute('data-mode');
            
            currentSearchTerm = searchTerm;
            
            if (!searchTerm) {
                // 恢复之前的排序
                currentSortMode = previousSortMode;
                document.getElementById('sort-select').value = previousSortMode;
                renderConfigList();
                return;
            }
            
            // 按空格分隔关键词
            const keywords = searchTerm.split(/\s+/).filter(k => k);
            
            let filtered = savedConfigs.filter(config => {
                if (searchMode === 'exact') {
                    // 精确搜索:必须包含所有关键词
                    return keywords.every(keyword => config.name.includes(keyword));
                } else {
                    // 模糊搜索:包含任一关键词即可
                    return keywords.some(keyword => config.name.includes(keyword));
                }
            });

            // 搜索时的特殊排序
            filtered = filtered.map(config => {
                // 计算匹配度
                let matchScore = 0;
                keywords.forEach(keyword => {
                    const index = config.name.indexOf(keyword);
                    if (index !== -1) {
                        // 位置越靠前得分越高
                        matchScore += (1000 - index);
                        // 关键词长度越长得分越高
                        matchScore += keyword.length * 10;
                    }
                });
                return { ...config, matchScore };
            });

            // 排序: 1. 匹配度 2. 时间倒序 3. 名称A-Z
            filtered.sort((a, b) => {
                if (a.matchScore !== b.matchScore) {
                    return b.matchScore - a.matchScore;
                }
                if (a.timestamp !== b.timestamp) {
                    return b.timestamp - a.timestamp;
                }
                return a.name.localeCompare(b.name, 'zh-CN');
            });
            
            renderConfigList(filtered, true);
        }

        // 排序配置
        function sortConfigs() {
            const sortMode = document.getElementById('sort-select').value;
            currentSortMode = sortMode;
            
            // 只有在非搜索状态下才保存为默认排序
            if (!currentSearchTerm) {
                previousSortMode = sortMode;
            }
            
            renderConfigList();
        }

        // 渲染配置列表
        function renderConfigList(filteredConfigs = null, isSearchResult = false) {
            const configList = document.getElementById('config-list');
            let configs = filteredConfigs || [...savedConfigs];
            
            // 如果不是搜索结果,应用用户选择的排序
            if (!isSearchResult) {
                const sortMode = currentSortMode;
                
                configs.sort((a, b) => {
                    switch(sortMode) {
                        case 'time-desc':
                            return b.timestamp - a.timestamp;
                        case 'time-asc':
                            return a.timestamp - b.timestamp;
                        case 'name-asc':
                            return a.name.localeCompare(b.name, 'zh-CN');
                        case 'name-desc':
                            return b.name.localeCompare(a.name, 'zh-CN');
                        default:
                            return b.timestamp - a.timestamp;
                    }
                });
            }
            
            if (configs.length === 0) {
                const message = isSearchResult ? '无匹配结果' : '暂无保存的配置';
                configList.innerHTML = `<div class="no-results">${message}</div>`;
                return;
            }
            
            configList.innerHTML = '';
            configs.forEach((config, index) => {
                const date = new Date(config.timestamp);
                const dateStr = date.toLocaleString('zh-CN');
                
                const configHtml = `
                    <div class="config-item">
                        <div style="flex: 1;">
                            <div class="config-name" contenteditable="false" data-config-id="${config.id}" onclick="loadConfig('${config.id}')">${config.name}</div>
                            <div class="config-time">${dateStr}</div>
                        </div>
                        <div class="config-actions">
                            <button class="rename-btn" onclick="renameConfig('${config.id}', event)">重命名</button>
                            <button class="delete-btn" onclick="deleteConfig('${config.id}')">删除</button>
                        </div>
                    </div>
                `;
                configList.insertAdjacentHTML('beforeend', configHtml);
            });
        }

        // 加载配置
        function loadConfig(configId) {
            const nameEl = document.querySelector(`[data-config-id="${configId}"]`);
            if (nameEl && nameEl.contentEditable === 'true') {
                return; // 正在编辑中,不加载
            }
            
            const config = savedConfigs.find(c => c.id === configId);
            if (!config) return;
            
            applyConfig(config);
            closeConfigList();
            showToast('配置加载成功!');
        }

        // 重命名配置
        function renameConfig(configId, event) {
            event.stopPropagation();
            const nameEl = document.querySelector(`[data-config-id="${configId}"]`);
            
            if (nameEl.contentEditable === 'true') {
                // 保存重命名
                nameEl.contentEditable = 'false';
                nameEl.classList.remove('editing');
                
                const config = savedConfigs.find(c => c.id === configId);
                if (config) {
                    config.name = nameEl.textContent.trim() || config.name;
                    saveSavedConfigs();
                    showToast('重命名成功!');
                }
                
                event.target.textContent = '重命名';
            } else {
                // 开始编辑
                nameEl.contentEditable = 'true';
                nameEl.classList.add('editing');
                nameEl.focus();
                
                // 选中文本
                const range = document.createRange();
                range.selectNodeContents(nameEl);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                
                event.target.textContent = '保存';
            }
        }

        // 删除配置
        function deleteConfig(configId) {
            if (!confirm('确定要删除这个配置吗?')) return;
            
            savedConfigs = savedConfigs.filter(c => c.id !== configId);
            saveSavedConfigs();
            
            // 重新过滤和渲染
            if (currentSearchTerm) {
                filterConfigs();
            } else {
                renderConfigList();
            }
            showToast('配置已删除');
        }

        // 收集当前配置
        function collectConfig() {
            const config = {
                title: document.getElementById('title').value,
                mode: document.querySelector('input[name="mode"]:checked').value,
                customTag: document.getElementById('custom-tag').value,
                requirements: document.getElementById('requirements').value,
                background: document.getElementById('background').value,
                style: document.getElementById('style').value,
                worldviewMode: document.querySelector('input[name="worldview"]:checked').value,
                worldviewCustom: document.getElementById('worldview-custom').value,
                length: document.getElementById('length').value,
                genre: document.getElementById('genre').value,
                elements: document.getElementById('elements').value,
                elementsRepeat: document.getElementById('elements-repeat').value,
                fieldToggles: {},
                customFields: []
            };

            // 收集字段开关状态
            document.querySelectorAll('[data-field]').forEach(field => {
                const fieldName = field.getAttribute('data-field');
                const toggle = field.querySelector('.toggle-switch');
                config.fieldToggles[fieldName] = toggle.classList.contains('active');
            });

            // 收集自定义字段
            const customFields = document.querySelectorAll('.custom-field');
            customFields.forEach(field => {
                const fieldData = extractFieldData(field);
                config.customFields.push(fieldData);
            });

            return config;
        }

        // 应用配置
        function applyConfig(config) {
            document.getElementById('title').value = config.title || '番外';
            document.querySelector(`input[name="mode"][value="${config.mode}"]`).checked = true;
            document.getElementById('custom-tag').value = config.customTag || 'little-play';
            toggleModeOptions();
            document.getElementById('requirements').value = config.requirements || '';
            document.getElementById('background').value = config.background || '';
            document.getElementById('style').value = config.style || '';
            document.querySelector(`input[name="worldview"][value="${config.worldviewMode}"]`).checked = true;
            document.getElementById('worldview-custom').value = config.worldviewCustom || '';
            toggleWorldviewInput();
            document.getElementById('length').value = config.length || '2000';
            document.getElementById('genre').value = config.genre || '';
            document.getElementById('elements').value = config.elements || '';
            document.getElementById('elements-repeat').value = config.elementsRepeat || '1';

            // 应用字段开关状态
            if (config.fieldToggles) {
                Object.keys(config.fieldToggles).forEach(fieldName => {
                    const field = document.querySelector(`[data-field="${fieldName}"]`);
                    if (field) {
                        const toggle = field.querySelector('.toggle-switch');
                        if (config.fieldToggles[fieldName]) {
                            toggle.classList.add('active');
                            field.classList.remove('disabled');
                        } else {
                            toggle.classList.remove('active');
                            field.classList.add('disabled');
                        }
                    }
                });
            }

            // 清空并重建自定义字段
            document.getElementById('custom-fields-container').innerHTML = '';
            customFieldCounter = 0;
            
            if (config.customFields && config.customFields.length > 0) {
                config.customFields.forEach(fieldData => {
                    addCustomField();
                    const fieldId = 'custom-field-' + customFieldCounter;
                    const fieldElement = document.getElementById(fieldId);
                    applyFieldData(fieldElement, fieldData, fieldId);
                });
            }
            
            autoGenerate();
        }

        // 导出配置
        function exportConfig(format) {
            if (format === 'json') {
                const config = collectConfig();
                const title = document.getElementById('title').value.trim() || '未命名';
                const now = new Date();
                const timeStr = now.getFullYear() + 
                                String(now.getMonth() + 1).padStart(2, '0') + 
                                String(now.getDate()).padStart(2, '0') + '_' +
                                String(now.getHours()).padStart(2, '0') + 
                                String(now.getMinutes()).padStart(2, '0') + 
                                String(now.getSeconds()).padStart(2, '0');
                const timestamp = now.getTime();
                
                const dataStr = JSON.stringify(config, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `小剧场配置_${title}_${timeStr}_${timestamp}.json`;
                link.click();
                URL.revokeObjectURL(url);
                showToast('JSON配置导出成功!');
            } else if (format === 'txt') {
                const output = document.getElementById('output').textContent;
                if (!output) {
                    showToast('没有内容可导出', 'error');
                    return;
                }
                const title = document.getElementById('title').value.trim() || '未命名';
                const now = new Date();
                const timeStr = now.getFullYear() + 
                                String(now.getMonth() + 1).padStart(2, '0') + 
                                String(now.getDate()).padStart(2, '0') + '_' +
                                String(now.getHours()).padStart(2, '0') + 
                                String(now.getMinutes()).padStart(2, '0') + 
                                String(now.getSeconds()).padStart(2, '0');
                const timestamp = now.getTime();
                
                const blob = new Blob([output], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `小剧场配置_${title}_${timeStr}_${timestamp}.txt`;
                link.click();
                URL.revokeObjectURL(url);
                showToast('TXT文本导出成功!');
            }
        }

        // 导入配置
        function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    if (fileName.endsWith('.json')) {
                        // JSON格式导入
                        const config = JSON.parse(content);
                        applyConfig(config);
                        showToast('配置导入成功!');
                    } else if (fileName.endsWith('.txt')) {
                        // TXT格式导入
                        parseTxtConfig(content);
                        showToast('TXT配置导入成功!');
                    } else {
                        showToast('不支持的文件格式', 'error');
                    }
                } catch (error) {
                    console.error(error);
                    showToast('导入失败,文件格式错误', 'error');
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }

        // 解析TXT配置
        function parseTxtConfig(content) {
            const config = {
                fieldToggles: {},
                customFields: []
            };
            
            // 提取标题
            const titleMatch = content.match(/【小剧场·(.+?)】/);
            if (titleMatch) {
                config.title = titleMatch[1];
            }
            
            // 判断使用模式
            if (content.startsWith('<little-play>')) {
                config.mode = 'worldbook';
            } else if (content.startsWith('<puppy>')) {
                config.mode = 'puppy';
            } else if (content.match(/^<(.+?)>/)) {
                config.mode = 'custom';
                const tagMatch = content.match(/^<(.+?)>/);
                config.customTag = tagMatch[1];
            } else {
                config.mode = 'independent';
            }
            
            // 提取生成要求
            let reqStart = content.indexOf('整体要求:');
            if (config.mode === 'independent') {
                reqStart = content.indexOf('- 本次回复需暂停一切正文输出,立刻输出本剧场内容。');
                if (reqStart !== -1) {
                    reqStart = content.indexOf('\n', reqStart) + 1;
                }
            } else {
                if (reqStart !== -1) {
                    reqStart = content.indexOf('\n', reqStart) + 1;
                }
            }
            
            const reqEnd = content.indexOf('- 小剧场标题需根据内容动态生成。');
            if (reqStart !== -1 && reqEnd !== -1) {
                config.requirements = content.substring(reqStart, reqEnd).trim();
            }
            
            // 提取其他字段
            const lines = content.split('\n');
            const defaultFields = {
                '故事背景': 'background',
                '文风': 'style',
                '世界观&题材': 'worldview',
                '篇幅': 'length',
                '体裁': 'genre',
                '元素要求': 'elements'
            };
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line.startsWith('- ')) continue;
                
                const colonIndex = line.indexOf(':');
                if (colonIndex === -1) continue;
                
                const fieldName = line.substring(2, colonIndex).trim();
                let fieldContent = line.substring(colonIndex + 1).trim();
                
                // 处理多行内容
                let j = i + 1;
                while (j < lines.length && !lines[j].trim().startsWith('- ') && lines[j].trim() !== '') {
                    fieldContent += '\n' + lines[j].trim();
                    if (fieldContent.includes('}}')) break;
                    j++;
                }
                
                // 检查是否为默认字段
                let isDefaultField = false;
                for (const [key, value] of Object.entries(defaultFields)) {
                    if (fieldName === key) {
                        isDefaultField = true;
                        
                        if (value === 'worldview') {
                            if (fieldContent === '剧场内容根据主线剧情和当前世界观动态适配。') {
                                config.worldviewMode = 'consistent';
                            } else {
                                config.worldviewMode = 'custom';
                                config.worldviewCustom = extractRandomContent(fieldContent);
                            }
                        } else if (value === 'elements') {
                            const originalValue = line.substring(colonIndex + 1).trim();
                            config.elementsRepeat = countRandomOccurrences(originalValue);
                            config[value] = extractRandomContent(fieldContent);
                        } else if (value === 'length') { // [GEMINI] BUGFIX: 添加对'length'的特殊处理
                            const numberMatch = fieldContent.match(/\d+/); // 提取数字
                            if (numberMatch) {
                                config[value] = numberMatch[0];
                            } else {
                                config[value] = '2000'; // 默认回退
                            }
                        } else {
                            config[value] = extractRandomContent(fieldContent);
                        }
                        break;
                    }
                }
                
                // 如果不是默认字段,添加为自定义字段
                if (!isDefaultField && fieldName !== '小剧场标题需根据内容动态生成' && fieldName !== '剧情必须完整,从开头到结尾,不能仅是剧情片段') {
                    config.customFields.push({
                        name: fieldName,
                        type: 'random',
                        content: extractRandomContent(fieldContent),
                        enabled: true,
                        repeat: countRandomOccurrences(fieldContent)
                    });
                }
            }
            
            // 应用配置
            applyConfig(config);
        }

        // 提取{{random:...}}中的内容（支持嵌套{{}}）
        function extractRandomContent(text) {
            // 查找第一个{{random:
            const randomStart = text.indexOf('{{random:');
            if (randomStart === -1) {
                // 如果不包含{{random:，但可能包含{{}}，直接返回（或根据需要返回剥离了{{}}的内容）
                // 鉴于上下文，可能是没有{{random:}}的纯文本，直接返回
                return text;
            }
            
            // 找到匹配的结束}}
            let depth = 2; // {{random: 中已有两个{
            let i = randomStart + 9;
            
            while (i < text.length && depth > 0) {
                if (text[i] === '{') {
                    depth++;
                } else if (text[i] === '}') {
                    depth--;
                }
                i++;
            }
            
            if (depth === 0) {
                return text.substring(randomStart + 9, i - 2);
            }
            
            // 如果没有找到匹配的结束}}，说明格式有问题，但还是尝试返回开始{{random:}}之后的内容
            return text.substring(randomStart + 9);
        }

        // 计算{{random:...}}出现的次数（支持嵌套）
        function countRandomOccurrences(text) {
            let count = 0;
            let i = 0;
            
            while (i < text.length) {
                if (i <= text.length - 9 && text.substring(i, i + 9) === '{{random:') {
                    count++;
                    // 跳过这个{{random:...}}的内容
                    let depth = 2;
                    i += 9;
                    while (i < text.length && depth > 0) {
                        if (text[i] === '{') {
                            depth++;
                        } else if (text[i] === '}') {
                            depth--;
                        }
                        i++;
                    }
                } else {
                    i++;
                }
            }
            
            return count > 0 ? count : 1;
        }
    </script>
</body>
</html>
